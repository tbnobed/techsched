{% extends "base.html" %}

{% block content %}
<div class="calendar-container">
    <div class="calendar-header d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <h2>{{ week_start.strftime('%B %Y') }}</h2>
            <div class="ms-4">
                <select class="form-select" onchange="applyLocationFilter(this.value)">
                    <option value="">All Locations</option>
                    {% for location in locations %}
                    <option value="{{ location.id }}" {% if selected_location == location.id %}selected{% endif %}>
                        {{ location.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="calendar-controls">
            {% if personal_view %}
            <a href="{{ url_for('personal_schedule', week_start=(week_start - timedelta(days=28)).strftime('%Y-%m-%d')) }}" 
               class="btn btn-outline-secondary me-2">
                <i data-feather="chevrons-left"></i> Previous Month
            </a>
            <a href="{{ url_for('personal_schedule', week_start=(week_start - timedelta(days=7)).strftime('%Y-%m-%d')) }}" 
               class="btn btn-outline-primary me-2">
                <i data-feather="chevron-left"></i> Previous Week
            </a>
            <a href="{{ url_for('personal_schedule') }}" 
               class="btn btn-outline-primary me-2">
                Current Week
            </a>
            <a href="{{ url_for('personal_schedule', week_start=(week_start + timedelta(days=7)).strftime('%Y-%m-%d')) }}"
               class="btn btn-outline-primary me-2">
                Next Week <i data-feather="chevron-right"></i>
            </a>
            <a href="{{ url_for('personal_schedule', week_start=(week_start + timedelta(days=28)).strftime('%Y-%m-%d')) }}"
               class="btn btn-outline-secondary me-2">
                Next Month <i data-feather="chevrons-right"></i>
            </a>
            {% else %}
            <button type="button" class="btn btn-outline-secondary me-2" id="prev-month-btn">
                <i data-feather="chevrons-left"></i> Previous Month
            </button>
            <button type="button" class="btn btn-outline-primary me-2" id="prev-week-btn">
                <i data-feather="chevron-left"></i> Previous Week
            </button>
            <button type="button" class="btn btn-outline-primary me-2" id="current-week-btn">
                Current Week
            </button>
            <button type="button" class="btn btn-outline-primary me-2" id="next-week-btn">
                Next Week <i data-feather="chevron-right"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary me-2" id="next-month-btn">
                Next Month <i data-feather="chevrons-right"></i>
            </button>
            {% endif %}
            {% if current_user.is_admin %}
            <form method="POST" action="{{ url_for('copy_previous_week_schedules') }}" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="target_week_start" value="{{ week_start.strftime('%Y-%m-%d') }}">
                <button type="submit" class="btn btn-success">
                    <i data-feather="copy"></i> Copy Previous Week
                </button>
            </form>
            {% endif %}
        </div>
    </div>

    <script>
        function applyLocationFilter(locationId) {
            const currentUrl = new URL(window.location.href);
            if (locationId) {
                currentUrl.searchParams.set('location_id', locationId);
            } else {
                currentUrl.searchParams.delete('location_id');
            }
            window.location.href = currentUrl.toString();
        }
    </script>

    <div class="calendar-grid">
        <div class="time-column">
            {% for hour in range(24) %}
                <div class="hour-slot">{{ "%02d:00"|format(hour) }}</div>
            {% endfor %}
        </div>

        {% for day in range(7) %}
        {% set current_date = week_start + timedelta(days=day) %}
        {% set is_today = current_date.date() == today.date() %}
        <div class="day-column {{ 'today' if is_today else '' }}">
            <div class="day-header {{ 'today' if is_today else '' }}">
                {{ current_date.strftime('%A %m/%d') }}
            </div>
            <div class="day-slots" data-date="{{ current_date.strftime('%Y-%m-%d') }}">
                {% for hour in range(24) %}
                    <div class="time-slot" data-hour="{{ '%02d'|format(hour) }}"></div>
                {% endfor %}
                {% for schedule in schedules if schedule.start_time.date() == current_date.date() %}
                    <div class="schedule-event"
                         style="background-color: {{ '#6a6d6c' if schedule.time_off else schedule.technician.color }}"
                         data-schedule-id="{{ schedule.id }}"
                         data-technician-id="{{ schedule.technician_id }}"
                         data-start-time="{{ schedule.start_time.strftime('%Y-%m-%d %H:%M:%S') }}"
                         data-end-time="{{ schedule.end_time.strftime('%Y-%m-%d %H:%M:%S') }}"
                         data-time-off="{{ 'true' if schedule.time_off else 'false' }}"
                         data-toggle="tooltip"
                         data-html="true"
                         title="<div class='hover-content'><strong>{{ schedule.technician.username }}</strong> <span class='text-muted'>{{ schedule.start_time.strftime('%m/%d/%y') }}</span><br>{{ schedule.start_time.strftime('%H:%M') }}-{{ schedule.end_time.strftime('%H:%M') }} ({{ ((schedule.end_time - schedule.start_time).total_seconds() / 3600)|int }}h){% if schedule.location %}<br><i data-feather='map-pin'></i> {{ schedule.location.name }}{% endif %}{{ ('<br>' + schedule.description) if schedule.description else '' }}</div>">
                        <div class="schedule-time">
                            {{ schedule.start_time.strftime('%H:%M') }} - 
                            {{ schedule.end_time.strftime('%H:%M') }}
                        </div>
                        <div class="schedule-tech">{{ schedule.technician.username }}</div>
                        {% if schedule.location %}
                        <div class="schedule-location"><i data-feather="map-pin"></i> {{ schedule.location.name }}</div>
                        {% endif %}
                        <div class="schedule-desc">{{ schedule.description }}</div>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="modal fade" id="scheduleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Schedule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="schedule_form" method="POST" action="{{ url_for('new_schedule', personal_view=personal_view) }}">
                        {{ form.hidden_tag() }}
                        <input type="hidden" id="schedule_id" name="schedule_id">
                        {% if request.args.get('week_start') %}
                        <input type="hidden" name="week_start" value="{{ request.args.get('week_start') }}">
                        {% endif %}
                        {% if current_user.is_admin %}
                        <div class="mb-3">
                            {{ form.technician.label(class="form-label") }}
                            {{ form.technician(class="form-control") }}
                        </div>
                        {% endif %}
                        <div class="mb-3">
                            {{ form.description.label(class="form-label") }}
                            {{ form.description(class="form-control", id="description") }}
                        </div>
                        <div class="mb-3">
                            {{ form.location_id.label(class="form-label") }}
                            {{ form.location_id(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" id="schedule_date" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Repeat Schedule</label>
                            <div class="mt-2">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="repeat_days_toggle" onchange="toggleRepeatDaysSelection()">
                                    <label class="form-check-label" for="repeat_days_toggle">Schedule for multiple days</label>
                                </div>
                            </div>
                            <div id="repeat_days_container" class="mt-2" style="display: none;">
                                <div class="alert alert-info mb-3">
                                    <small>Select the days to create this schedule. The same time and details will be used for all selected days.</small>
                                </div>
                                <div class="mini-calendar">
                                    <div class="month-navigator d-flex justify-content-between align-items-center mb-2">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="prev-month">
                                            <i data-feather="chevron-left"></i>
                                        </button>
                                        <h6 class="m-0" id="calendar-month-year">March 2025</h6>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="next-month">
                                            <i data-feather="chevron-right"></i>
                                        </button>
                                    </div>
                                    <div class="calendar-days">
                                        <div class="day-names d-flex">
                                            <div>Sun</div>
                                            <div>Mon</div>
                                            <div>Tue</div>
                                            <div>Wed</div>
                                            <div>Thu</div>
                                            <div>Fri</div>
                                            <div>Sat</div>
                                        </div>
                                        <div class="day-grid" id="calendar-days">
                                            <!-- Days will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="selected-dates mt-3">
                                    <div class="d-flex mb-2">
                                        <strong>Selected Dates:</strong>
                                        <button type="button" class="btn btn-sm btn-link ms-auto" id="clear-selection">Clear All</button>
                                    </div>
                                    <div id="selected-dates-container" class="d-flex flex-wrap">
                                        <!-- Selected dates will appear here -->
                                        <span class="text-muted" id="no-dates-selected">No additional dates selected</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label">Start Time</label>
                                <select id="start_hour" class="form-control" onchange="updateEndTimeOptions()">
                                    {% for hour in range(24) %}
                                        <option value="{{ '%02d'|format(hour) }}">{{ '%02d:00'|format(hour) }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col">
                                <label class="form-label">End Time</label>
                                <select id="end_hour" class="form-control">
                                    {% for hour in range(1, 24) %}
                                        <option value="{{ '%02d'|format(hour) }}">{{ '%02d:00'|format(hour) }}</option>
                                    {% endfor %}
                                    <option value="00">00:00</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            {{ form.time_off.label(class="form-check-label") }}
                            {{ form.time_off(class="form-check-input", id="time_off") }}
                        </div>
                        {{ form.start_time(type="hidden", id="start_time_input") }}
                        {{ form.end_time(type="hidden", id="end_time_input") }}
                        {{ form.repeat_days(type="hidden", id="repeat_days_input") }}
                        <div class="modal-footer">
                            <button type="button" id="delete_button" class="btn btn-danger" style="display: none;">Delete</button>
                            <button type="button" id="copy_button" class="btn btn-info" style="display: none;">Copy Schedule</button>
                            <button type="submit" class="btn btn-primary">Add Schedule</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
</div> <!-- Close calendar-container -->

<style>
/* Add custom tooltip styling */
.tooltip {
    position: absolute;
    z-index: 1070;
    display: block;
    font-size: 0.875rem;
    opacity: 0;
    transition: opacity 0.15s;
}

.tooltip.show {
    opacity: 1;
}

.tooltip-inner {
    max-width: 200px;
    padding: 0.4rem 0.6rem;
    color: #fff;
    text-align: left;
    background-color: rgba(0, 0, 0, 0.9);
    border-radius: 0.25rem;
    white-space: nowrap;
}

.hover-content {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.3;
}

.hover-content span.text-muted {
    font-style: italic;
    font-size: 0.85em;
    opacity: 0.8;
}

/* Mini-calendar styles */
.mini-calendar {
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 1rem;
    background-color: #f8f9fa;
}

.day-names {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    font-weight: 500;
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 0.5rem;
}

.day-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    grid-gap: 3px;
}

.day-item {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 36px;
    border-radius: 0.25rem;
    cursor: pointer;
    user-select: none;
    font-size: 0.9rem;
}

.day-item:hover:not(.disabled) {
    background-color: #e2e6ea;
}

.day-item.outside-month {
    color: #adb5bd;
}

.day-item.today {
    border: 1px solid #007bff;
    font-weight: bold;
}

.day-item.selected {
    background-color: #007bff;
    color: white;
}

.day-item.primary-date {
    background-color: #28a745;
    color: white;
}

.day-item.disabled {
    color: #adb5bd;
    cursor: not-allowed;
    background-color: #e9ecef;
}

.day-item.has-schedule {
    position: relative;
}

.day-item.has-schedule:after {
    content: '';
    position: absolute;
    bottom: 4px;
    left: 50%;
    transform: translateX(-50%);
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background-color: #dc3545;
}

.date-tag {
    background-color: #e2e6ea;
    border-radius: 0.25rem;
    padding: 0.2rem 0.5rem;
    margin: 0.25rem;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
}

.date-tag .close {
    margin-left: 0.5rem;
    font-size: 0.9rem;
    cursor: pointer;
    display: flex;
    align-items: center;
}

#selected-dates-container {
    min-height: 38px;
}
</style>

<script>
// Function to handle AJAX calendar navigation
function setupCalendarNavigation() {
    // AJAX calendar navigation
    const prevMonthBtn = document.getElementById('prev-month-btn');
    const prevWeekBtn = document.getElementById('prev-week-btn');
    const currentWeekBtn = document.getElementById('current-week-btn');
    const nextWeekBtn = document.getElementById('next-week-btn');
    const nextMonthBtn = document.getElementById('next-month-btn');
    
    if (prevMonthBtn) {
        prevMonthBtn.addEventListener('click', function() {
            navigateCalendar(-28);
        });
    }
    
    if (prevWeekBtn) {
        prevWeekBtn.addEventListener('click', function() {
            navigateCalendar(-7);
        });
    }
    
    if (currentWeekBtn) {
        currentWeekBtn.addEventListener('click', function() {
            // Force loading the current week by setting current=true
            const url = new URL(window.location.href);
            url.searchParams.delete('week_start');
            url.searchParams.set('current', 'true');
            fetchCalendarData(url.toString());
        });
    }
    
    if (nextWeekBtn) {
        nextWeekBtn.addEventListener('click', function() {
            navigateCalendar(7);
        });
    }
    
    if (nextMonthBtn) {
        nextMonthBtn.addEventListener('click', function() {
            navigateCalendar(28);
        });
    }
}

// Function to navigate the calendar by a specified number of days
function navigateCalendar(dayOffset) {
    // Get current week start from page data
    const currentWeekStart = "{{ week_start.strftime('%Y-%m-%d') }}";
    
    // Calculate new week start
    const date = new Date(currentWeekStart);
    date.setDate(date.getDate() + dayOffset);
    const newWeekStart = date.toISOString().split('T')[0];
    
    // Build URL with the new week_start parameter
    const url = new URL(window.location.href);
    url.searchParams.set('week_start', newWeekStart);
    
    // Fetch the calendar data
    fetchCalendarData(url.toString());
}

// Function to fetch calendar data via AJAX
function fetchCalendarData(url) {
    // Convert the full URL to just the parameters
    const apiUrl = new URL('/api/calendar_data', window.location.origin);
    const params = new URL(url).searchParams;
    
    // Copy over the parameters we need
    if (params.has('week_start')) {
        apiUrl.searchParams.set('week_start', params.get('week_start'));
    }
    if (params.has('location_id')) {
        apiUrl.searchParams.set('location_id', params.get('location_id'));
    }
    if (params.has('current')) {
        apiUrl.searchParams.set('current', params.get('current'));
    }
    
    // Fetch the calendar data from the API endpoint
    fetch(apiUrl.toString())
        .then(response => response.json())
        .then(data => {
            // Update the week range display
            const weekStart = new Date(data.week_start);
            const weekEnd = new Date(data.week_end);
            
            // Format dates for display
            const weekStartStr = weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const weekEndStr = weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            
            // Update header if it exists
            const header = document.querySelector('.calendar-header h2');
            if (header) {
                header.textContent = `${weekStart.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`;
            }
            
            // Clear all existing day columns
            const dayColumns = document.querySelectorAll('.day-column');
            const today = data.today;
            
            // Update each day column with the new dates
            dayColumns.forEach((column, index) => {
                const currentDate = new Date(weekStart);
                currentDate.setDate(currentDate.getDate() + index);
                const dateStr = currentDate.toISOString().split('T')[0];
                
                // Update date in column header
                const header = column.querySelector('.day-header');
                if (header) {
                    header.textContent = currentDate.toLocaleDateString('en-US', { weekday: 'long', month: 'numeric', day: 'numeric' });
                    
                    // Check if this is today
                    if (dateStr === today) {
                        column.classList.add('today');
                        header.classList.add('today');
                    } else {
                        column.classList.remove('today');
                        header.classList.remove('today');
                    }
                }
                
                // Set the data attribute on day slots
                const slots = column.querySelector('.day-slots');
                if (slots) {
                    slots.dataset.date = dateStr;
                }
                
                // Clear existing schedules
                const existingSchedules = column.querySelectorAll('.schedule-event');
                existingSchedules.forEach(schedule => schedule.remove());
            });
            
            // Add new schedules
            data.schedules.forEach(schedule => {
                const startDate = new Date(schedule.start_time);
                const endDate = new Date(schedule.end_time);
                const dateStr = startDate.toISOString().split('T')[0];
                
                // Find the corresponding day column
                const daySlots = document.querySelector(`.day-slots[data-date="${dateStr}"]`);
                if (daySlots) {
                    // Create schedule element
                    const scheduleEl = document.createElement('div');
                    scheduleEl.className = 'schedule-event';
                    scheduleEl.style.backgroundColor = schedule.time_off ? '#6a6d6c' : schedule.technician_color;
                    scheduleEl.dataset.scheduleId = schedule.id;
                    scheduleEl.dataset.technicianId = schedule.technician_id;
                    scheduleEl.dataset.startTime = schedule.start_time;
                    scheduleEl.dataset.endTime = schedule.end_time;
                    scheduleEl.dataset.timeOff = schedule.time_off;
                    scheduleEl.dataset.toggle = 'tooltip';
                    scheduleEl.dataset.html = true;
                    
                    // Format time for display
                    const startTimeStr = startDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                    const endTimeStr = endDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                    const dateStr = startDate.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit' });
                    const durationHours = Math.floor((endDate - startDate) / (1000 * 60 * 60));
                    
                    // Create tooltip content
                    scheduleEl.title = `<div class='hover-content'><strong>${schedule.technician_name}</strong> <span class='text-muted'>${dateStr}</span><br>${startTimeStr}-${endTimeStr} (${durationHours}h)${schedule.location_name ? `<br><i data-feather='map-pin'></i> ${schedule.location_name}` : ''}${schedule.description ? '<br>' + schedule.description : ''}</div>`;
                    
                    // Create schedule content
                    scheduleEl.innerHTML = `
                        <div class="schedule-time">${startTimeStr} - ${endTimeStr}</div>
                        <div class="schedule-tech">${schedule.technician_name}</div>
                        ${schedule.location_name ? `<div class="schedule-location"><i data-feather="map-pin"></i> ${schedule.location_name}</div>` : ''}
                        <div class="schedule-desc">${schedule.description || ''}</div>
                    `;
                    
                    // Add to day column
                    daySlots.appendChild(scheduleEl);
                }
            });
            
            // Re-initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-toggle="tooltip"]'));
            tooltipTriggerList.forEach(function(tooltipTriggerEl) {
                new bootstrap.Tooltip(tooltipTriggerEl, {
                    html: true,
                    container: 'body',
                    boundary: 'window'
                });
            });
            
            // Update URL without refreshing page
            window.history.pushState({}, '', url);
            
            // Auto-scroll to today if it's visible
            const todayColumns = document.querySelectorAll('.day-column.today');
            if (todayColumns.length > 0) {
                todayColumns[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            // Initialize Feather icons
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        })
        .catch(error => {
            console.error('Error fetching calendar data:', error);
        });
}

// Initialize tooltips after the document is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function(tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl, {
            html: true,
            container: 'body',
            boundary: 'window'
        });
    });
    
    // Auto-scroll to current date in calendar
    const todayColumns = document.querySelectorAll('.day-column.today');
    if (todayColumns.length > 0) {
        setTimeout(function() {
            todayColumns[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 500); // Short delay to ensure calendar is fully rendered
    }
    
    // Setup AJAX navigation for calendar
    setupCalendarNavigation();
    
    // Auto highlight today
    const todayDate = new Date().toISOString().split('T')[0];
    document.querySelectorAll('.day-column').forEach(column => {
        const dateElement = column.querySelector('.day-slots');
        if (dateElement && dateElement.dataset.date === todayDate) {
            column.classList.add('today');
            column.querySelector('.day-header').classList.add('today');
        }
    });
});
</script>
{% endblock %}