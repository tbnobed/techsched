{% extends "mobile_base.html" %}

{% block title %}Mobile Calendar | The Plex Studios{% endblock %}

{% block content %}
<!-- Override the entire block to move calendar to top -->
<div class="container mt-2 mb-4">
    <!-- Mobile-friendly daily view (one day at a time) - Placed at the very top -->
    <div class="mobile-calendar mb-3">
        <!-- Date selector integrated at the top of the calendar section -->
        <div class="row mb-3">
            <div class="col-12">
                <h2 class="mobile-title mb-2" style="background: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}linear-gradient(120deg, #f8f9fa, #e9ecef){% else %}linear-gradient(120deg, #141B2D, #1A2332){% endif %}; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#dee2e6{% else %}#273449{% endif %};">
                    <button class="btn btn-sm" onclick="previousWeek()" style="color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#495057{% else %}#e2e2e2{% endif %};">
                        <i data-feather="chevron-left"></i>
                    </button>
                    <span id="current-date-range" style="white-space: nowrap; font-size: 1.2rem; color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#212529{% else %}#ffffff{% endif %}; font-weight: 500;">
                        {{ week_start.strftime('%b %d') }} - {{ (week_start + timedelta(days=6)).strftime('%b %d, %Y') }}
                    </span>
                    <button class="btn btn-sm" onclick="nextWeek()" style="color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#495057{% else %}#e2e2e2{% endif %};">
                        <i data-feather="chevron-right"></i>
                    </button>
                </h2>
            </div>
        </div>
        <div class="day-selector mb-3">
            <ul class="nav nav-pills nav-fill">
                {% for day in range(7) %}
                {% set current_date = week_start + timedelta(days=day) %}
                <li class="nav-item">
                    <button class="nav-link {% if day == 0 %}active{% endif %}" 
                            onclick="showDay({{ day }})"
                            data-day="{{ day }}"
                            style="color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#212529{% else %}#f8f9fa{% endif %};">
                        {{ current_date.strftime('%a') }}<br>
                        <span class="day-number">{{ current_date.day }}</span>
                    </button>
                </li>
                {% endfor %}
            </ul>
        </div>

        {% for day in range(7) %}
        {% set current_date = week_start + timedelta(days=day) %}
        <div class="day-container {% if day != 0 %}d-none{% endif %}" id="day-{{ day }}">
            <div class="day-header">
                <h4>{{ current_date.strftime('%A, %B %d, %Y') }}</h4>
            </div>
            <div class="day-schedules">
                {% set ns = namespace(has_schedules = false) %}
                
                {% set day_schedules = [] %}
                {% for schedule in schedules %}
                    {% if schedule.start_time.year == current_date.year and schedule.start_time.month == current_date.month and schedule.start_time.day == current_date.day %}
                        {% set _ = day_schedules.append(schedule) %}
                    {% endif %}
                {% endfor %}
                
                {% for schedule in day_schedules|sort(attribute='start_time') %}
                    {% set ns.has_schedules = true %}
                    <div class="mobile-schedule-card {% if schedule.time_off %}time-off-card{% endif %}" 
                         style="--tech-color: {{ schedule.technician.color }};"
                         data-bs-toggle="modal" 
                         data-bs-target="#scheduleModal"
                         data-schedule-id="{{ schedule.id }}"
                         data-start-time="{{ schedule.start_time }}"
                         data-end-time="{{ schedule.end_time }}"
                         data-time-off="{{ 'true' if schedule.time_off else 'false' }}">
                        <div class="schedule-time">
                            {% if schedule.time_off %}
                            <span class="time-off-badge">Time Off</span>
                            {% endif %}
                            {{ schedule.start_time.strftime('%I:%M %p') }} - {{ schedule.end_time.strftime('%I:%M %p') }}
                        </div>
                        <div class="schedule-tech">
                            {{ schedule.technician.username }}
                        </div>
                        {% if schedule.location %}
                        <div class="schedule-location">
                            <i data-feather="map-pin" class="feather-small"></i> {{ schedule.location.name }}
                        </div>
                        {% endif %}
                        {% if schedule.description %}
                        <div class="schedule-desc">
                            {{ schedule.description }}
                        </div>
                        {% endif %}
                    </div>
                {% endfor %}
                
                {% if not ns.has_schedules %}
                    <div class="empty-day-message">
                        <p>No schedules for this day.</p>
                        <button class="btn btn-sm btn-outline-primary" 
                                data-bs-toggle="modal" 
                                data-bs-target="#scheduleModal"
                                data-date="{{ current_date.strftime('%Y-%m-%d') }}"
                                style="border-color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#0d6efd{% else %}#0d6efd{% endif %}; 
                                       color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#0d6efd{% else %}#0d6efd{% endif %};">
                            <i data-feather="plus"></i> Add Schedule
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Controls moved below the calendar -->
    <div class="mobile-controls mt-1 mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <a href="{{ url_for('calendar', week_start=(week_start - timedelta(days=7)).strftime('%Y-%m-%d')) }}" 
               class="btn btn-outline-secondary btn-sm"
               style="color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#495057{% else %}#f8f9fa{% endif %}; 
                      border-color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#6c757d{% else %}#f8f9fa{% endif %};">
                <i data-feather="arrow-left"></i> Previous Week
            </a>
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#scheduleModal">
                <i data-feather="plus"></i> Add Schedule
            </button>
            <a href="{{ url_for('calendar', week_start=(week_start + timedelta(days=7)).strftime('%Y-%m-%d')) }}" 
               class="btn btn-outline-secondary btn-sm"
               style="color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#495057{% else %}#f8f9fa{% endif %}; 
                      border-color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#6c757d{% else %}#f8f9fa{% endif %};">
                Next Week <i data-feather="arrow-right"></i>
            </a>
        </div>
    </div>
</div>

<!-- Schedule Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Schedule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="schedule_form" method="POST" action="{{ url_for('new_schedule') }}">
                    {{ form.hidden_tag() }}
                    <input type="hidden" id="schedule_id" name="schedule_id">
                    {% if request.args.get('week_start') %}
                    <input type="hidden" name="week_start" value="{{ request.args.get('week_start') }}">
                    {% endif %}
                    <!-- Make sure technician_id is always included -->
                    {% if not current_user.is_admin %}
                    <input type="hidden" name="technician" value="{{ current_user.id }}">
                    {% endif %}
                    <!-- Hidden field for direct date selection -->
                    <input type="hidden" name="direct_repeat_days_list" id="direct_repeat_days_list" value="">
                    <!-- Hidden field for repeat_days that matches the form field name in ScheduleForm -->
                    <input type="hidden" name="repeat_days" id="repeat_days_input" value="">
                    
                    {% if current_user.is_admin %}
                    <div class="mb-3">
                        {{ form.technician.label(class="form-label") }}
                        {{ form.technician(class="form-control") }}
                    </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        {{ form.description.label(class="form-label") }}
                        {{ form.description(class="form-control", id="description", rows="3") }}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.location_id.label(class="form-label") }}
                        {{ form.location_id(class="form-control") }}
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Date</label>
                        <input type="date" id="schedule_date" name="schedule_date" class="form-control">
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Start Time</label>
                            <select class="form-control" id="start_hour" name="start_hour">
                                {% for hour in range(24) %}
                                <option value="{{ '%02d'|format(hour) }}">{{ '%02d'|format(hour) }}:00</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">End Time</label>
                            <select class="form-control" id="end_hour" name="end_hour">
                                {% for hour in range(24) %}
                                <option value="{{ '%02d'|format(hour) }}">{{ '%02d'|format(hour) }}:00</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="time_off" name="time_off">
                        <label class="form-check-label" for="time_off">{{ form.time_off.label.text }}</label>
                    </div>
                    
                    <div class="mb-3" id="repeat_days_section">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="enable_repeat_days" onchange="toggleRepeatDaysCalendar()">
                            <label class="form-check-label" for="enable_repeat_days">Repeat on additional days</label>
                        </div>
                        <div id="repeat_days_calendar" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6>Select additional days:</h6>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="directClearDateSelection()">Clear All</button>
                            </div>
                            
                            <!-- Direct Mini Calendar for Month Navigation -->
                            <div class="mini-calendar mb-3">
                                <div class="month-navigator d-flex justify-content-between align-items-center">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="direct-prev-month-btn">
                                        <i data-feather="chevron-left"></i>
                                    </button>
                                    <span id="direct-current-month-display" style="color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#212529{% else %}#ffffff{% endif %};">Month Year</span>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="direct-next-month-btn">
                                        <i data-feather="chevron-right"></i>
                                    </button>
                                </div>
                                
                                <div class="day-names d-flex">
                                    <div class="flex-fill text-center">Su</div>
                                    <div class="flex-fill text-center">Mo</div>
                                    <div class="flex-fill text-center">Tu</div>
                                    <div class="flex-fill text-center">We</div>
                                    <div class="flex-fill text-center">Th</div>
                                    <div class="flex-fill text-center">Fr</div>
                                    <div class="flex-fill text-center">Sa</div>
                                </div>
                                
                                <div id="direct-calendar-days" class="d-flex flex-wrap">
                                    <!-- Calendar days will be generated by JavaScript -->
                                </div>
                            </div>
                            
                            <!-- Selected dates will appear here -->
                            <div id="selected-dates-container" class="mb-3">
                                <strong>Selected dates:</strong>
                                <div id="selected-dates-list" class="d-flex flex-wrap">
                                    <!-- Selected dates will appear here -->
                                </div>
                            </div>
                            
                            <!-- Hidden input for repeat_days -->
                            <div id="repeat_days_inputs" style="display: none;">
                                <!-- This will be filled by JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden field for repeat_days -->
                    <input type="hidden" id="repeat_days_duplicate" name="repeat_days_duplicate" value="">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id="delete_button" class="btn btn-danger" style="display: none;">Delete</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="document.getElementById('schedule_form').submit();">Add Schedule</button>
            </div>
        </div>
    </div>
</div>

<style>
.mobile-title {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    /* Theme colors are now controlled via inline styles */
}

.mobile-title span, .mobile-title button, .mobile-title i {
    /* Theme-specific colors are now handled inline */
}

.mobile-controls {
    margin-bottom: 15px;
}

.day-selector .nav-link {
    padding: 8px 5px;
    text-align: center;
    border-radius: 4px;
    margin: 0 2px;
    font-size: 0.9rem;
    border: 1px solid {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#dddddd{% else %}#273449{% endif %};
    background-color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#f8f9fa{% else %}#1A2332{% endif %};
    color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#000000{% else %}#e2e2e2{% endif %};
    transition: all 0.2s ease;
}

.day-selector .nav-link:hover {
    background-color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#e9ecef{% else %}#273449{% endif %};
    transform: translateY(-2px);
}

.day-selector .nav-link.active {
    background-color: #0d6efd;
    color: white !important;
    border-color: #0d6efd;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.day-number {
    font-size: 1rem;
    font-weight: bold;
}

.day-container {
    border: 1px solid {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#dee2e6{% else %}#273449{% endif %};
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    background-color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#ffffff{% else %}#141B2D{% endif %};
}

.day-header {
    background: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}linear-gradient(to right, #e9ecef, #f8f9fa){% else %}linear-gradient(to right, #1A2332, #273449){% endif %};
    color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#000000{% else %}#ffffff{% endif %};
    padding: 10px;
    text-align: center;
    font-weight: bold;
    border-bottom: 1px solid #e0e0e0;
}

.day-header h4 {
    margin: 0;
    font-weight: bold;
    color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#000000{% else %}#ffffff{% endif %};
}

.day-schedules {
    max-height: calc(100vh - 250px);
    overflow-y: auto;
    padding: 10px;
}

.mobile-schedule-card {
    background: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}linear-gradient(to right, #ffffff, #f8f9fa){% else %}linear-gradient(to right, #141B2D, #1A2332){% endif %};
    border-radius: 8px;
    padding: 10px 10px 10px 15px;
    margin-bottom: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    border: 1px solid {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#e0e0e0{% else %}#273449{% endif %};
}

.mobile-schedule-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 5px;
    height: 100%;
    background-color: var(--tech-color, var(--primary));
}

.mobile-schedule-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    border-color: var(--tech-color, var(--primary));
}

.schedule-time {
    font-weight: bold;
    font-size: 1rem;
    color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#000000{% else %}#ffffff{% endif %};
}

.schedule-tech {
    color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#000000{% else %}#ffffff{% endif %};
    margin-bottom: 5px;
    font-weight: 500;
}

.schedule-location, .schedule-desc {
    font-size: 0.9rem;
    margin-top: 5px;
    color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#000000{% else %}#e2e2e2{% endif %};
    word-break: break-word;
}

.empty-day-message {
    text-align: center;
    padding: 20px 0;
    color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#6c757d{% else %}#a9b0ba{% endif %};
}

.feather-small {
    width: 14px;
    height: 14px;
}

.time-off-card {
    background-color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#f8f9fa{% else %}#2d3035{% endif %} !important;
    border-color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#dee2e6{% else %}#495057{% endif %} !important;
    color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#000000{% else %}#e2e2e2{% endif %} !important;
}

.time-off-card .schedule-time,
.time-off-card .schedule-tech,
.time-off-card .schedule-location,
.time-off-card .schedule-desc {
    color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#000000{% else %}#e2e2e2{% endif %} !important;
}

.time-off-card::before {
    background-color: var(--tech-color, #6c757d) !important;
    width: 5px !important;
    opacity: 0.7;
}

.time-off-badge {
    background-color: #c32f37; /* Dark red */
    color: white;
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 4px;
    margin-right: 5px;
    display: inline-block;
    vertical-align: middle;
}

/* Repeat days styling */
.repeat-days-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-bottom: 15px;
}

.date-checkbox {
    position: relative;
}

.date-checkbox-input {
    position: absolute;
    opacity: 0;
}

.date-checkbox-label {
    display: block;
    padding: 8px 5px;
    text-align: center;
    font-size: 0.85rem;
    border: 1px solid {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#dee2e6{% else %}#273449{% endif %};
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    background-color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#f8f9fa{% else %}#1A2332{% endif %};
    color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#212529{% else %}#e2e2e2{% endif %};
}

.date-checkbox-input:checked + .date-checkbox-label {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}

/* Mini Calendar Styles */
.mini-calendar {
    border: 1px solid {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#dee2e6{% else %}#273449{% endif %};
    border-radius: 8px;
    padding: 10px;
    background-color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#ffffff{% else %}#141B2D{% endif %};
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.month-navigator {
    background: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}linear-gradient(to right, #e9ecef, #f8f9fa){% else %}linear-gradient(to right, #1A2332, #273449){% endif %};
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.day-names {
    display: flex;
    background-color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#f8f9fa{% else %}#1A2332{% endif %};
    padding: 5px 0;
    border-radius: 4px;
    font-weight: 600;
    margin-bottom: 8px;
}

.day-names div {
    text-align: center;
    color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#495057{% else %}#e2e2e2{% endif %};
    font-size: 0.8rem;
}

.day-item {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 30px;
    font-size: 0.8rem;
    color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#212529{% else %}#e2e2e2{% endif %};
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s;
    margin: 2px;
    padding: 2px;
}

.day-item:hover:not(.disabled) {
    background-color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#e9ecef{% else %}#273449{% endif %};
}

.day-item.outside-month {
    color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#adb5bd{% else %}#6c757d{% endif %};
}

.day-item.today {
    border: 1px solid #0d6efd;
}

.day-item.selected {
    background-color: #0d6efd;
    color: white;
}

.day-item.primary-date {
    background-color: #6c757d;
    color: white;
}

.day-item.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.date-tag {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    background-color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#f8f9fa{% else %}#273449{% endif %};
    border: 1px solid {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#dee2e6{% else %}#1A2332{% endif %};
    border-radius: 4px;
    font-size: 0.8rem;
    color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#212529{% else %}#e2e2e2{% endif %};
}

.btn-close-sm {
    font-size: 0.6rem;
    padding: 2px;
}

/* Removed redundant dark theme overrides since we're now using conditional theme colors directly */
</style>

<script>
function showDay(dayIndex) {
    // Hide all day containers
    document.querySelectorAll('.day-container').forEach(container => {
        container.classList.add('d-none');
    });
    
    // Show the selected day
    document.getElementById(`day-${dayIndex}`).classList.remove('d-none');
    
    // Update active state in the pills
    document.querySelectorAll('.day-selector .nav-link').forEach(link => {
        link.classList.remove('active');
    });
    document.querySelector(`.day-selector .nav-link[data-day="${dayIndex}"]`).classList.add('active');
}

function previousWeek() {
    window.location.href = "{{ url_for('calendar', week_start=(week_start - timedelta(days=7)).strftime('%Y-%m-%d')) }}";
}

function nextWeek() {
    window.location.href = "{{ url_for('calendar', week_start=(week_start + timedelta(days=7)).strftime('%Y-%m-%d')) }}";
}

// Mini Calendar Variables
let currentDate = new Date();
let currentMonth = currentDate.getMonth();
let currentYear = currentDate.getFullYear();
let selectedDates = new Set(); // Store selected dates
let primaryDate = null; // Main schedule date

function toggleRepeatDaysCalendar() {
    const enableRepeatDays = document.getElementById('enable_repeat_days');
    const repeatDaysCalendar = document.getElementById('repeat_days_calendar');
    
    if (enableRepeatDays && repeatDaysCalendar) {
        repeatDaysCalendar.style.display = enableRepeatDays.checked ? 'block' : 'none';
        
        if (enableRepeatDays.checked) {
            // Initialize the direct calendar when showing the repeat days section
            // Get the selected date (from the day selector) and pass as the primary date
            const activeDayIndex = parseInt(document.querySelector('.day-selector .nav-link.active').getAttribute('data-day'));
            const primaryDateObj = new Date("{{ week_start.strftime('%Y-%m-%d') }}");
            primaryDateObj.setDate(primaryDateObj.getDate() + activeDayIndex);
            
            // Format as YYYY-MM-DD
            const year = primaryDateObj.getFullYear();
            const month = String(primaryDateObj.getMonth() + 1).padStart(2, '0');
            const day = String(primaryDateObj.getDate()).padStart(2, '0');
            const primaryDateStr = `${year}-${month}-${day}`;
            
            initDirectCalendar('direct-calendar-days', primaryDateStr);
            
            // Update feather icons
            if (typeof feather !== 'undefined') {
                feather.replace({
                    'stroke-width': 1.5,
                    'width': 16,
                    'height': 16
                });
            }
        }
    }
}

function clearDateSelection() {
    // Clear all selected dates
    selectedDates.clear();
    
    // Update selected dates display
    updateSelectedDatesDisplay();
    
    // Clear checkboxes as well (for backward compatibility)
    document.querySelectorAll('input[name="repeat_days"]').forEach(cb => {
        cb.checked = false;
    });
    
    // Update calendar to reflect cleared selection
    generateCalendarDays();
}

// Initialize the mini calendar
function initMiniCalendar() {
    // Get the primary date from the schedule date input
    const dateInput = document.getElementById('schedule_date');
    primaryDate = dateInput.value;
    
    // Set current month/year based on primary date
    if (primaryDate) {
        const primaryDateObj = new Date(primaryDate);
        currentMonth = primaryDateObj.getMonth();
        currentYear = primaryDateObj.getFullYear();
    }
    
    // Update month/year display
    updateCalendarHeader();
    
    // Generate calendar days
    generateCalendarDays();
    
    // Add event listeners for navigation buttons
    document.getElementById('prev-month-btn').addEventListener('click', function() {
        navigateMonth(-1);
    });
    
    document.getElementById('next-month-btn').addEventListener('click', function() {
        navigateMonth(1);
    });
}

// Update the calendar header (month and year)
function updateCalendarHeader() {
    const monthNames = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];
    
    document.getElementById('current-month-display').textContent = 
        `${monthNames[currentMonth]} ${currentYear}`;
}

// Navigate to previous or next month
function navigateMonth(direction) {
    currentMonth += direction;
    
    if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
    } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
    }
    
    updateCalendarHeader();
    generateCalendarDays();
}

// Get days in month (handles leap years correctly)
function getDaysInMonth(year, month) {
    return new Date(year, month + 1, 0).getDate();
}

// Format date from year, month, day components
function formatDateFromComponents(year, month, day) {
    return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
}

// Generate calendar days for the current month
function generateCalendarDays() {
    const calendarDays = document.getElementById('calendar-days');
    calendarDays.innerHTML = '';
    
    // First day of the current month - use plain number calculations
    // Use JavaScript's built-in date API minimally to avoid timezone issues
    const daysInCurrentMonth = getDaysInMonth(currentYear, currentMonth);
    
    // Calculate the day of the week for the first day of the month (0 = Sunday)
    const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
    const startingDayOfWeek = firstDayOfMonth.getDay();

    // Calculate previous month for display
    let prevMonthYear = currentYear;
    let prevMonth = currentMonth - 1;
    if (prevMonth < 0) {
        prevMonth = 11; // December
        prevMonthYear--;
    }
    
    // Calculate next month for display
    let nextMonthYear = currentYear;
    let nextMonth = currentMonth + 1;
    if (nextMonth > 11) {
        nextMonth = 0; // January
        nextMonthYear++;
    }
    
    // Get today's date components for highlighting
    const today = new Date();
    const todayYear = today.getFullYear();
    const todayMonth = today.getMonth();
    const todayDay = today.getDate();
    
    // Add the days from the previous month to fill the first row
    const daysInPrevMonth = getDaysInMonth(prevMonthYear, prevMonth);
    for (let i = startingDayOfWeek - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        
        // Format date string directly from components to avoid timezone conversion
        const dateYear = prevMonthYear;
        const dateMonth = prevMonth + 1; // JavaScript months are 0-indexed
        const dateDay = day;
        const dateFormatted = formatDateFromComponents(dateYear, dateMonth, dateDay);
        
        const isToday = dateYear === todayYear && dateMonth === todayMonth + 1 && dateDay === todayDay;
        
        addDayToCalendar(calendarDays, day, dateFormatted, 'outside-month', 
            isToday, 
            dateFormatted === primaryDate,
            selectedDates.has(dateFormatted),
            dateYear, dateMonth, dateDay);
    }
    
    // Add the days of the current month
    for (let day = 1; day <= daysInCurrentMonth; day++) {
        // Format date string directly
        const dateFormatted = formatDateFromComponents(currentYear, currentMonth + 1, day);
        
        const isToday = currentYear === todayYear && currentMonth === todayMonth && day === todayDay;
        
        addDayToCalendar(calendarDays, day, dateFormatted, '', 
            isToday, 
            dateFormatted === primaryDate,
            selectedDates.has(dateFormatted),
            currentYear, currentMonth + 1, day);
    }
    
    // Add days from the next month to complete the grid (always show 6 rows)
    const totalCells = 42; // 6 rows x 7 columns
    const cellsToAdd = totalCells - (startingDayOfWeek + daysInCurrentMonth);
    
    for (let day = 1; day <= cellsToAdd; day++) {
        // Format date string directly
        const dateFormatted = formatDateFromComponents(nextMonthYear, nextMonth + 1, day);
        
        const isToday = nextMonthYear === todayYear && nextMonth === todayMonth && day === todayDay;
        
        addDayToCalendar(calendarDays, day, dateFormatted, 'outside-month', 
            isToday, 
            dateFormatted === primaryDate,
            selectedDates.has(dateFormatted),
            nextMonthYear, nextMonth + 1, day);
    }
}

// Add a day to the calendar
function addDayToCalendar(container, day, dateFormatted, extraClass, isToday, isPrimary, isSelected, year, month, dayNum) {
    const dayItem = document.createElement('div');
    dayItem.textContent = day;
    dayItem.className = `day-item${extraClass ? ' ' + extraClass : ''}${isToday ? ' today' : ''}`;
    
    if (isPrimary) {
        dayItem.classList.add('primary-date');
        dayItem.setAttribute('title', 'Primary schedule date');
    } else if (isSelected) {
        dayItem.classList.add('selected');
    }
    
    // Use the provided date components from parameters (year, month, dayNum)
    // We pass these explicitly now to avoid any timezone conversion issues
    dayItem.setAttribute('data-date', dateFormatted);
    dayItem.setAttribute('data-year', year);
    dayItem.setAttribute('data-month', month);
    dayItem.setAttribute('data-day', dayNum);
    
    // Add click event to select/deselect the date
    if (!isPrimary) { // Don't allow selecting the primary date
        dayItem.addEventListener('click', function() {
            // Create the exact date string directly from the attributes
            const clickedYear = this.getAttribute('data-year');
            const clickedMonth = this.getAttribute('data-month').padStart(2, '0');
            const clickedDay = this.getAttribute('data-day').padStart(2, '0');
            const exactDateStr = `${clickedYear}-${clickedMonth}-${clickedDay}`;
            
            toggleDateSelection(exactDateStr, dayItem);
        });
    } else {
        dayItem.classList.add('disabled');
    }
    
    // Fix the width to make a 7-column grid
    dayItem.style.width = 'calc(100% / 7)';
    
    container.appendChild(dayItem);
}

// Format a date as YYYY-MM-DD with timezone handling
function formatDate(date) {
    // Create a new Date with the time set to noon to avoid timezone issues
    const adjustedDate = new Date(date);
    adjustedDate.setHours(12, 0, 0, 0); // Set to noon to avoid DST issues
    
    const year = adjustedDate.getFullYear();
    const month = String(adjustedDate.getMonth() + 1).padStart(2, '0');
    const day = String(adjustedDate.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Toggle date selection
function toggleDateSelection(dateFormatted, dayItem) {
    if (selectedDates.has(dateFormatted)) {
        selectedDates.delete(dateFormatted);
        dayItem.classList.remove('selected');
    } else {
        selectedDates.add(dateFormatted);
        dayItem.classList.add('selected');
    }
    
    // Update the hidden input or form data
    updateFormWithSelectedDates();
    
    // Show selected dates
    updateSelectedDatesDisplay();
}

// Update the form with selected dates
function updateFormWithSelectedDates() {
    console.log("Updating form with selected dates");
    
    // Get selected dates as a comma-separated string
    const datesStr = Array.from(selectedDates).join(',');
    console.log("Selected dates: ", datesStr);
    
    // Update direct_repeat_days_list field
    const directRepeatDaysField = document.getElementById('direct_repeat_days_list');
    if (directRepeatDaysField) {
        directRepeatDaysField.value = datesStr;
        console.log("Updated direct_repeat_days_list: ", directRepeatDaysField.value);
    }
    
    // Update repeat_days field - this is the field that matches ScheduleForm
    const repeatDaysField = document.getElementById('repeat_days_input');
    if (repeatDaysField) {
        repeatDaysField.value = datesStr;
        console.log("Updated repeat_days_input: ", repeatDaysField.value);
    }
    
    // For backward compatibility, update any other repeat_days fields
    document.querySelectorAll('input[name="repeat_days"]').forEach(cb => {
        if (cb.type === 'checkbox') {
            cb.checked = false;
        } else if (cb.type === 'hidden') {
            cb.value = datesStr;
            console.log("Updated additional repeat_days field: ", cb.value);
        }
    });
}

// Display selected dates below calendar
function updateSelectedDatesDisplay() {
    const container = document.getElementById('selected-dates-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (selectedDates.size === 0) {
        container.innerHTML = '<span class="text-muted">None selected</span>';
        return;
    }
    
    // Sort dates chronologically
    const sortedDates = Array.from(selectedDates).sort();
    
    // Add date tags
    sortedDates.forEach(date => {
        const dateObj = new Date(date);
        const dateTag = document.createElement('div');
        dateTag.className = 'date-tag m-1 p-1';
        dateTag.innerHTML = `
            ${dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
            <button type="button" class="btn-close btn-close-sm ms-1" aria-label="Remove" 
                    onclick="removeDate('${date}')"></button>
        `;
        container.appendChild(dateTag);
    });
}

// Remove a date from selection
function removeDate(date) {
    if (selectedDates.has(date)) {
        selectedDates.delete(date);
        
        // Update the calendar visual state - search by exact attributes to avoid any issues
        const dateParts = date.split('-');
        const year = parseInt(dateParts[0]);
        const month = parseInt(dateParts[1]);
        const day = parseInt(dateParts[2]);
        
        const dayItem = document.querySelector(`.day-item[data-year="${year}"][data-month="${month}"][data-day="${day}"]`);
        if (dayItem) {
            dayItem.classList.remove('selected');
        }
        
        // Update form and display
        updateFormWithSelectedDates();
        updateSelectedDatesDisplay();
    }
}

// Clear all selected dates
function clearDateSelection() {
    // Clear the set of selected dates
    selectedDates.clear();
    
    // Remove 'selected' class from all day items
    document.querySelectorAll('.day-item.selected').forEach(dayItem => {
        dayItem.classList.remove('selected');
    });
    
    // Update the form and display
    updateFormWithSelectedDates();
    updateSelectedDatesDisplay();
}

// Function to initialize the direct calendar when the modal is shown
function initializeCalendarInModal() {
    console.log("Initializing calendar in modal");
    
    // Make sure date input has a value (today if not set)
    const dateInput = document.getElementById('schedule_date');
    if (!dateInput.value) {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        dateInput.value = `${year}-${month}-${day}`;
        console.log("Set default date to today:", dateInput.value);
    }
    
    // Clear any previous selections
    if (typeof directClearDateSelection === 'function') {
        directClearDateSelection();
    }
    
    // Initialize the calendar with the current date
    if (typeof initDirectCalendar === 'function') {
        console.log("Initializing direct calendar with date:", dateInput.value);
        initDirectCalendar('direct-calendar-days', dateInput.value);
    } else {
        console.error("Direct calendar functions not available");
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize Feather icons
    if (typeof feather !== 'undefined') {
        feather.replace({
            'stroke-width': 1.5,
            'width': 16,
            'height': 16
        });
    }
    
    // Add listener for modal shown event
    const scheduleModal = document.getElementById('scheduleModal');
    if (scheduleModal) {
        scheduleModal.addEventListener('shown.bs.modal', function(event) {
            console.log("Schedule modal shown");
            
            // Set Plex as default location when creating a new schedule
            const scheduleId = document.getElementById('schedule_id').value;
            if (!scheduleId) {
                console.log("Setting default location to Plex");
                const locationSelect = document.getElementById('location_id');
                if (locationSelect) {
                    // Find the Plex option
                    for (let i = 0; i < locationSelect.options.length; i++) {
                        if (locationSelect.options[i].text.trim() === 'Plex') {
                            locationSelect.selectedIndex = i;
                            console.log("Default location set to Plex");
                            break;
                        }
                    }
                }
            }
            
            // Make sure the script is loaded before initializing
            if (typeof initDirectCalendar === 'function') {
                initializeCalendarInModal();
            } else {
                console.log("Direct calendar script not loaded yet, loading now");
                // The script hasn't loaded yet, load it
                const scriptElement = document.createElement('script');
                scriptElement.src = "{{ url_for('static', filename='js/direct-date-selector.js') }}";
                scriptElement.onload = function() {
                    console.log("Direct calendar script loaded on demand");
                    initializeCalendarInModal();
                };
                document.head.appendChild(scriptElement);
            }
        });
    }
    
    // Also load the script on page load to ensure it's available
    console.log("Loading direct calendar script on page load");
    const scriptElement = document.createElement('script');
    scriptElement.src = "{{ url_for('static', filename='js/direct-date-selector.js') }}";
    scriptElement.onload = function() {
        console.log("Direct calendar script loaded on page load");
        
        // Attach date change event listener
        const dateInput = document.getElementById('schedule_date');
        if (dateInput) {
            dateInput.addEventListener('change', function() {
                console.log("Date input changed to:", this.value);
                if (typeof directClearDateSelection === 'function') {
                    directClearDateSelection();
                    directPrimaryDate = this.value;
                    directGenerateCalendarDays();
                }
            });
        }
    };
    document.head.appendChild(scriptElement);
    
    // Add event listeners to the schedule cards
    document.querySelectorAll('.mobile-schedule-card').forEach(card => {
        card.addEventListener('click', function() {
            const scheduleId = this.getAttribute('data-schedule-id');
            const startTime = new Date(this.getAttribute('data-start-time'));
            const endTime = new Date(this.getAttribute('data-end-time'));
            const timeOff = this.getAttribute('data-time-off') === 'true';
            
            // Populate the modal with schedule data
            document.getElementById('schedule_id').value = scheduleId;
            
            // Fix for date display - extract date directly from data attribute
            const startTimeStr = this.getAttribute('data-start-time').split(' ')[0]; // Get YYYY-MM-DD portion
            console.log("Original date from server:", this.getAttribute('data-start-time'));
            
            // Add more detailed debugging
            const rawDate = new Date(this.getAttribute('data-start-time'));
            console.log("JavaScript Date object:", rawDate);
            console.log("Date as ISO string:", rawDate.toISOString());
            console.log("Date in local timezone:", rawDate.toString());
            console.log("Local year/month/day:", rawDate.getFullYear() + '-' + 
                       (rawDate.getMonth() + 1).toString().padStart(2, '0') + '-' + 
                       rawDate.getDate().toString().padStart(2, '0'));
            console.log("UTC year/month/day:", rawDate.getUTCFullYear() + '-' + 
                       (rawDate.getUTCMonth() + 1).toString().padStart(2, '0') + '-' + 
                       rawDate.getUTCDate().toString().padStart(2, '0'));
            
            // Always use the original server date string
            console.log("Using date from server:", startTimeStr);
            
            document.getElementById('schedule_date').value = startTimeStr;
            
            // Set start and end times
            const startHour = document.getElementById('start_hour');
            if (startHour) {
                startHour.value = String(startTime.getHours()).padStart(2, '0');
            }
            
            const endHour = document.getElementById('end_hour');
            if (endHour) {
                const displayEndHour = endTime.getHours() === 0 ? '00' : String(endTime.getHours()).padStart(2, '0');
                endHour.value = displayEndHour;
            }
            
            // Set time off checkbox
            document.getElementById('time_off').checked = timeOff;
            
            // Get description
            const descElement = this.querySelector('.schedule-desc');
            document.getElementById('description').value = descElement ? descElement.textContent.trim() : '';
            
            // Get location if present
            const locationElement = this.querySelector('.schedule-location');
            const locationSelect = document.getElementById('location_id');
            
            if (locationElement && locationSelect) {
                // Try to find the location name in the dropdown
                const locationName = locationElement.textContent.trim().replace('map-pin', '').trim();
                console.log("Setting location from:", locationName);
                
                let locationFound = false;
                for (let i = 0; i < locationSelect.options.length; i++) {
                    if (locationSelect.options[i].text.trim() === locationName) {
                        locationSelect.selectedIndex = i;
                        locationFound = true;
                        console.log("Location matched:", locationSelect.options[i].text);
                        break;
                    }
                }
                
                if (!locationFound) {
                    console.log("No matching location found for:", locationName);
                }
            } else if (locationSelect) {
                // No location in the schedule - set to Plex as default
                console.log("No location found in schedule, setting to Plex");
                
                // Find Plex in the options
                for (let i = 0; i < locationSelect.options.length; i++) {
                    if (locationSelect.options[i].text.trim() === 'Plex') {
                        locationSelect.selectedIndex = i;
                        console.log("Default location set to Plex");
                        break;
                    }
                }
            }
            
            // Update modal title and buttons
            document.querySelector('#scheduleModal .modal-title').textContent = 'Edit Schedule';
            document.getElementById('delete_button').style.display = 'block';
            document.querySelector('#scheduleModal .btn-primary').textContent = 'Save Changes';
            
            // Set up delete button event
            document.getElementById('delete_button').onclick = function() {
                if (confirm('Are you sure you want to delete this schedule?')) {
                    window.location.href = `/schedule/delete/${scheduleId}?week_start={{ week_start.strftime('%Y-%m-%d') }}&personal_view=false`;
                }
            };
        });
    });
    
    // Handle empty day buttons
    document.querySelectorAll('.empty-day-message button').forEach(button => {
        button.addEventListener('click', function() {
            const date = this.getAttribute('data-date');
            if (date) {
                document.getElementById('schedule_date').value = date;
                document.getElementById('schedule_id').value = '';
                document.getElementById('description').value = '';
                document.getElementById('time_off').checked = false;
                
                // Set default location to Plex
                const locationSelect = document.getElementById('location_id');
                if (locationSelect) {
                    // Find the Plex option
                    for (let i = 0; i < locationSelect.options.length; i++) {
                        if (locationSelect.options[i].text.trim() === 'Plex') {
                            locationSelect.selectedIndex = i;
                            console.log("Setting default location to Plex");
                            break;
                        }
                    }
                }
                
                document.querySelector('#scheduleModal .modal-title').textContent = 'Add New Schedule';
                document.getElementById('delete_button').style.display = 'none';
                document.querySelector('#scheduleModal .btn-primary').textContent = 'Add Schedule';
            }
        });
    });
});
</script>
{% endblock %}