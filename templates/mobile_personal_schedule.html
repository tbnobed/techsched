{% extends "base.html" %}

{% block title %}My Schedule | The Plex Studios{% endblock %}

{% block content %}
<div class="container mt-4 mb-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mobile-title mb-3">
                <button class="btn btn-sm" onclick="previousWeek()">
                    <i data-feather="chevron-left"></i>
                </button>
                <span id="current-date-range">{{ week_start.strftime('%b %d') }} - {{ (week_start + timedelta(days=6)).strftime('%b %d, %Y') }}</span>
                <button class="btn btn-sm" onclick="nextWeek()">
                    <i data-feather="chevron-right"></i>
                </button>
            </h2>
        </div>
    </div>

    <div class="mobile-controls mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <a href="{{ url_for('personal_schedule', week_start=(week_start - timedelta(days=7)).strftime('%Y-%m-%d')) }}" class="btn btn-outline-secondary btn-sm">
                <i data-feather="arrow-left"></i> Previous Week
            </a>
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#scheduleModal">
                <i data-feather="plus"></i> Add Schedule
            </button>
            <a href="{{ url_for('personal_schedule', week_start=(week_start + timedelta(days=7)).strftime('%Y-%m-%d')) }}" class="btn btn-outline-secondary btn-sm">
                Next Week <i data-feather="arrow-right"></i>
            </a>
        </div>
    </div>

    <!-- Mobile-friendly daily view (one day at a time) -->
    <div class="mobile-calendar">
        <div class="day-selector mb-3">
            <ul class="nav nav-pills nav-fill">
                {% for day in range(7) %}
                {% set current_date = week_start + timedelta(days=day) %}
                <li class="nav-item">
                    <button class="nav-link {% if day == 0 %}active{% endif %}" 
                            onclick="showDay({{ day }})"
                            data-day="{{ day }}">
                        {{ current_date.strftime('%a') }}<br>
                        <span class="day-number">{{ current_date.day }}</span>
                    </button>
                </li>
                {% endfor %}
            </ul>
        </div>

        {% for day in range(7) %}
        {% set current_date = week_start + timedelta(days=day) %}
        <div class="day-container {% if day != 0 %}d-none{% endif %}" id="day-{{ day }}">
            <div class="day-header">
                <h4>{{ current_date.strftime('%A, %B %d, %Y') }}</h4>
            </div>
            <div class="day-schedules">
                {% set has_schedules = false %}
                
                {% for schedule in schedules %}
                    {% if schedule.start_time.date() == current_date.date() %}
                        {% set has_schedules = true %}
                        <div class="mobile-schedule-card" 
                             style="--tech-color: {{ current_user.color }};"
                             data-bs-toggle="modal" 
                             data-bs-target="#scheduleModal"
                             data-schedule-id="{{ schedule.id }}"
                             data-start-time="{{ schedule.start_time }}"
                             data-end-time="{{ schedule.end_time }}"
                             data-time-off="{{ 'true' if schedule.time_off else 'false' }}">
                            <div class="schedule-time">
                                {{ schedule.start_time.strftime('%I:%M %p') }} - {{ schedule.end_time.strftime('%I:%M %p') }}
                            </div>
                            {% if schedule.location %}
                            <div class="schedule-location">
                                <i data-feather="map-pin" class="feather-small"></i> {{ schedule.location.name }}
                            </div>
                            {% endif %}
                            {% if schedule.time_off %}
                            <div class="time-off-badge">
                                <span class="badge bg-warning">Time Off</span>
                            </div>
                            {% endif %}
                            {% if schedule.description %}
                            <div class="schedule-desc">
                                {{ schedule.description }}
                            </div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
                
                {% if not has_schedules %}
                    <div class="empty-day-message">
                        <p>No schedules for this day.</p>
                        <button class="btn btn-sm btn-outline-primary" 
                                data-bs-toggle="modal" 
                                data-bs-target="#scheduleModal"
                                data-date="{{ current_date.strftime('%Y-%m-%d') }}">
                            Add Schedule
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Schedule Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scheduleModalLabel">Add New Schedule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('new_schedule') }}" id="scheduleForm">
                    {{ form.hidden_tag() }}
                    <input type="hidden" name="schedule_id" id="schedule_id" value="">
                    <input type="hidden" name="return_to" value="personal_schedule">
                    <input type="hidden" name="week_start" value="{{ week_start.strftime('%Y-%m-%d') }}">
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="schedule_date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="schedule_date" name="schedule_date" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-5">
                            <label for="start_hour" class="form-label">Start Time</label>
                            <div class="input-group">
                                <select class="form-select" id="start_hour" name="start_hour" required>
                                    {% for hour in range(24) %}
                                    <option value="{{ '%02d'|format(hour) }}">{{ '%02d'|format(hour) }}:00</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label for="end_hour" class="form-label">End Time</label>
                            <div class="input-group">
                                <select class="form-select" id="end_hour" name="end_hour" required>
                                    {% for hour in range(24) %}
                                    <option value="{{ '%02d'|format(hour) }}">{{ '%02d'|format(hour) }}:00</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="time_off" name="time_off" onchange="toggleRepeatDaysSelection()">
                                <label class="form-check-label" for="time_off">Time Off Request</label>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3" id="location_section">
                        <div class="col-md-12">
                            <label for="location_id" class="form-label">Location</label>
                            <select class="form-select" id="location_id" name="location_id">
                                <option value="">-- Select Location --</option>
                                {% for location in locations if location.active %}
                                <option value="{{ location.id }}">{{ location.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                        </div>
                    </div>

                    <div class="row mb-3" id="repeat_days_section">
                        <div class="col-md-12">
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="enable_repeat_days" onchange="toggleRepeatDaysCalendar()">
                                <label class="form-check-label" for="enable_repeat_days">Repeat on additional days</label>
                            </div>
                            <div id="repeat_days_calendar" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6>Select additional days:</h6>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearDateSelection()">Clear All</button>
                                </div>
                                <div class="repeat-days-grid">
                                    {% for i in range(28) %}
                                    {% set day_date = week_start + timedelta(days=i) %}
                                    {% if day_date.date() != week_start.date() %}
                                    <div class="date-checkbox">
                                        <input type="checkbox" id="repeat_day_{{ i }}" name="repeat_days" value="{{ day_date.strftime('%Y-%m-%d') }}" class="date-checkbox-input">
                                        <label for="repeat_day_{{ i }}" class="date-checkbox-label">
                                            {{ day_date.strftime('%b %d') }}
                                        </label>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="delete_button" style="display: none; margin-right: auto;">Delete</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="document.getElementById('scheduleForm').submit();">Add Schedule</button>
            </div>
        </div>
    </div>
</div>

<style>
.mobile-title {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(135deg, var(--accent-color-1), var(--accent-color-2));
    color: #ffffff !important; /* Ensuring text is always white regardless of theme */
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 15px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.4); /* Adding text shadow for better readability */
}

.mobile-title span, .mobile-title button, .mobile-title i {
    color: #ffffff !important;
}

.mobile-controls {
    margin-bottom: 15px;
}

.day-selector .nav-link {
    padding: 8px 5px;
    text-align: center;
    border-radius: 4px;
    margin: 0 2px;
    font-size: 0.9rem;
    border: 1px solid var(--border-color);
    background-color: var(--bg-light);
    color: var(--text-color);
    transition: all 0.2s ease;
}

.day-selector .nav-link:hover {
    background-color: var(--bg-hover);
    transform: translateY(-2px);
}

.day-selector .nav-link.active {
    background: linear-gradient(135deg, var(--accent-color-1), var(--accent-color-2));
    color: white !important;
    border-color: var(--accent-color-1);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.day-number {
    font-size: 1rem;
    font-weight: bold;
}

.day-container {
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 15px;
}

.day-header {
    background: linear-gradient(to bottom, var(--calendar-header-start), var(--calendar-header-end));
    color: var(--text-color);
    padding: 10px;
    text-align: center;
    font-weight: bold;
}

.day-header h4 {
    margin: 0;
    font-weight: bold;
    text-shadow: 0 1px 1px rgba(0,0,0,0.1);
}

.day-schedules {
    max-height: calc(100vh - 250px);
    overflow-y: auto;
    padding: 10px;
}

.mobile-schedule-card {
    background-color: var(--calendar-bg);
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.mobile-schedule-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 5px;
    height: 100%;
    background-color: var(--tech-color, var(--primary));
}

.mobile-schedule-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    border-color: var(--tech-color, var(--primary));
}

.schedule-time {
    font-weight: bold;
    font-size: 1rem;
}

.schedule-tech {
    color: var(--text-muted);
    margin-bottom: 5px;
}

.schedule-location, .schedule-desc {
    font-size: 0.9rem;
    margin-top: 5px;
    color: var(--text-secondary);
}

.time-off-badge {
    margin-top: 5px;
}

.empty-day-message {
    text-align: center;
    padding: 20px 0;
    color: var(--text-muted);
}

.feather-small {
    width: 14px;
    height: 14px;
}

.repeat-days-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    margin-bottom: 10px;
}

.date-checkbox {
    position: relative;
}

.date-checkbox-input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    height: 0;
    width: 0;
}

.date-checkbox-label {
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 5px;
    font-size: 0.8rem;
    text-align: center;
    cursor: pointer;
    background-color: var(--bg-light);
    transition: all 0.2s;
    display: block;
    margin: 0;
}

.date-checkbox-input:checked + .date-checkbox-label {
    background-color: var(--primary);
    color: white;
    border-color: var(--primary);
}

.date-checkbox-label:hover {
    background-color: var(--bg-hover);
}
</style>

<script>
function showDay(dayIndex) {
    // Hide all day containers
    document.querySelectorAll('.day-container').forEach(container => {
        container.classList.add('d-none');
    });
    
    // Show the selected day
    document.getElementById(`day-${dayIndex}`).classList.remove('d-none');
    
    // Update active state in the pills
    document.querySelectorAll('.day-selector .nav-link').forEach(link => {
        link.classList.remove('active');
    });
    document.querySelector(`.day-selector .nav-link[data-day="${dayIndex}"]`).classList.add('active');
}

function previousWeek() {
    window.location.href = "{{ url_for('personal_schedule', week_start=(week_start - timedelta(days=7)).strftime('%Y-%m-%d')) }}";
}

function nextWeek() {
    window.location.href = "{{ url_for('personal_schedule', week_start=(week_start + timedelta(days=7)).strftime('%Y-%m-%d')) }}";
}

function toggleRepeatDaysSelection() {
    const timeOffCheckbox = document.getElementById('time_off');
    const repeatDaysSection = document.getElementById('repeat_days_section');
    const locationSection = document.getElementById('location_section');
    
    if (timeOffCheckbox.checked) {
        // Hide repeat days if it's time off
        repeatDaysSection.style.display = 'none';
        // Clear any selected repeat days
        document.querySelectorAll('input[name="repeat_days"]').forEach(cb => {
            cb.checked = false;
        });
    } else {
        // Show repeat days for regular shifts
        repeatDaysSection.style.display = 'block';
    }
}

function toggleRepeatDaysCalendar() {
    const enableRepeatDays = document.getElementById('enable_repeat_days');
    const repeatDaysCalendar = document.getElementById('repeat_days_calendar');
    
    if (enableRepeatDays.checked) {
        repeatDaysCalendar.style.display = 'block';
    } else {
        repeatDaysCalendar.style.display = 'none';
        // Clear any selected dates
        document.querySelectorAll('input[name="repeat_days"]').forEach(cb => {
            cb.checked = false;
        });
    }
}

function clearDateSelection() {
    document.querySelectorAll('input[name="repeat_days"]').forEach(cb => {
        cb.checked = false;
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize Feather icons
    if (typeof feather !== 'undefined') {
        feather.replace({
            'stroke-width': 1.5,
            'width': 16,
            'height': 16
        });
    }
    
    // Set default values for new schedule entries
    document.querySelectorAll('.empty-day-message button').forEach(button => {
        button.addEventListener('click', function() {
            const date = this.getAttribute('data-date');
            if (date) {
                document.getElementById('schedule_date').value = date;
                document.getElementById('schedule_id').value = '';
                document.getElementById('description').value = '';
                document.getElementById('location_id').value = '';
                document.getElementById('time_off').checked = false;
                
                // Default to 9 AM start time for new entries
                const startHour = document.getElementById('start_hour');
                if (startHour) {
                    startHour.value = '09';
                }
                
                // Default to 5 PM end time for new entries
                const endHour = document.getElementById('end_hour');
                if (endHour) {
                    endHour.value = '17';
                }
                
                // Update modal title and buttons
                document.querySelector('#scheduleModal .modal-title').textContent = 'Add New Schedule';
                document.getElementById('delete_button').style.display = 'none';
                document.querySelector('#scheduleModal .btn-primary').textContent = 'Add Schedule';
                
                // Ensure repeat days and location sections are shown
                document.getElementById('repeat_days_section').style.display = 'block';
                document.getElementById('location_section').style.display = 'block';
                
                // Clear any repeat day selections
                document.getElementById('enable_repeat_days').checked = false;
                document.getElementById('repeat_days_calendar').style.display = 'none';
                clearDateSelection();
            }
        });
    });
    
    // Add event listeners to the schedule cards
    document.querySelectorAll('.mobile-schedule-card').forEach(card => {
        card.addEventListener('click', function() {
            const scheduleId = this.getAttribute('data-schedule-id');
            const startTime = new Date(this.getAttribute('data-start-time'));
            const endTime = new Date(this.getAttribute('data-end-time'));
            const timeOff = this.getAttribute('data-time-off') === 'true';
            
            // Populate the modal with schedule data
            document.getElementById('schedule_id').value = scheduleId;
            document.getElementById('schedule_date').valueAsDate = startTime;
            
            // Set start and end times
            const startHour = document.getElementById('start_hour');
            if (startHour) {
                startHour.value = String(startTime.getHours()).padStart(2, '0');
            }
            
            const endHour = document.getElementById('end_hour');
            if (endHour) {
                const displayEndHour = endTime.getHours() === 0 ? '00' : String(endTime.getHours()).padStart(2, '0');
                endHour.value = displayEndHour;
            }
            
            // Set time off checkbox and handle associated visibility
            document.getElementById('time_off').checked = timeOff;
            toggleRepeatDaysSelection();
            
            // Get description
            const descElement = this.querySelector('.schedule-desc');
            document.getElementById('description').value = descElement ? descElement.textContent.trim() : '';
            
            // Get location if present
            const locationElement = this.querySelector('.schedule-location');
            if (locationElement) {
                // Try to find the location name in the dropdown
                const locationName = locationElement.textContent.trim().replace('map-pin', '').trim();
                const locationSelect = document.getElementById('location_id');
                for (let i = 0; i < locationSelect.options.length; i++) {
                    if (locationSelect.options[i].text === locationName) {
                        locationSelect.value = locationSelect.options[i].value;
                        break;
                    }
                }
            } else {
                document.getElementById('location_id').value = '';
            }
            
            // Update modal title and buttons
            document.querySelector('#scheduleModal .modal-title').textContent = 'Edit Schedule';
            document.getElementById('delete_button').style.display = 'block';
            document.querySelector('#scheduleModal .btn-primary').textContent = 'Save Changes';
            
            // Hide repeat days for existing records
            document.getElementById('repeat_days_section').style.display = 'none';
            
            // Set up delete button event
            document.getElementById('delete_button').onclick = function() {
                if (confirm('Are you sure you want to delete this schedule?')) {
                    window.location.href = `/schedule/delete/${scheduleId}?week_start={{ week_start.strftime('%Y-%m-%d') }}&return_to=personal_schedule`;
                }
            };
        });
    });
    
    // Initial setup for repeat days toggle
    toggleRepeatDaysSelection();
});
</script>
{% endblock %}