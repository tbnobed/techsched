{% extends "base.html" %}

{% block content %}
<div class="calendar-container">
    <div class="calendar-header d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <h2>My Schedule - {{ week_start.strftime('%B %Y') }}</h2>
        </div>
        <div class="calendar-controls">
            <a href="{{ url_for('personal_schedule', week_start=(week_start - timedelta(days=28)).strftime('%Y-%m-%d')) }}" 
               class="btn btn-outline-secondary me-2">
                <i data-feather="chevrons-left"></i> Previous Month
            </a>
            <a href="{{ url_for('personal_schedule', week_start=(week_start - timedelta(days=7)).strftime('%Y-%m-%d')) }}" 
               class="btn btn-outline-primary me-2">
                <i data-feather="chevron-left"></i> Previous Week
            </a>
            <a href="{{ url_for('personal_schedule') }}" 
               class="btn btn-outline-primary me-2">
                Current Week
            </a>
            <a href="{{ url_for('personal_schedule', week_start=(week_start + timedelta(days=7)).strftime('%Y-%m-%d')) }}" 
               class="btn btn-outline-primary me-2">
                Next Week <i data-feather="chevron-right"></i>
            </a>
            <a href="{{ url_for('personal_schedule', week_start=(week_start + timedelta(days=28)).strftime('%Y-%m-%d')) }}" 
               class="btn btn-outline-secondary me-2">
                Next Month <i data-feather="chevrons-right"></i>
            </a>
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#scheduleModal">
                <i data-feather="plus"></i> Add Schedule
            </button>
        </div>
    </div>

    <div class="week-view">
        <div class="time-column">
            {% for hour in range(24) %}
                <div class="hour-slot">{{ "%02d:00"|format(hour) }}</div>
            {% endfor %}
        </div>

        {% for day in range(7) %}
        {% set current_date = week_start + timedelta(days=day) %}
        {% set is_today = current_date.date() == today.date() %}
        <div class="day-column {{ 'today' if is_today else '' }}">
            <div class="day-header {{ 'today' if is_today else '' }}">
                {{ current_date.strftime('%A %m/%d') }}
            </div>
            <div class="day-slots" data-date="{{ current_date.strftime('%Y-%m-%d') }}">
                {% for hour in range(24) %}
                    <div class="time-slot" data-hour="{{ '%02d'|format(hour) }}"></div>
                {% endfor %}
                {% for schedule in schedules if schedule.start_time.date() == current_date.date() %}
                    <div class="schedule-event"
                         style="background-color: {{ '#6a6d6c' if schedule.time_off else current_user.color }}"
                         data-schedule-id="{{ schedule.id }}"
                         data-technician-id="{{ schedule.technician_id }}"
                         data-start-time="{{ schedule.start_time.strftime('%Y-%m-%d %H:%M:%S') }}"
                         data-end-time="{{ schedule.end_time.strftime('%Y-%m-%d %H:%M:%S') }}"
                         data-time-off="{{ 'true' if schedule.time_off else 'false' }}"
                         data-toggle="tooltip"
                         data-html="true"
                         title="<div class='hover-content'><strong>{{ schedule.technician.username }}</strong> <span class='text-muted'>{{ schedule.start_time.strftime('%m/%d/%y') }}</span><br>{{ schedule.start_time.strftime('%H:%M') }}-{{ schedule.end_time.strftime('%H:%M') }} ({{ ((schedule.end_time - schedule.start_time).total_seconds() / 3600)|int }}h){% if schedule.location %}<br><i data-feather='map-pin'></i> {{ schedule.location.name }}{% endif %}{{ ('<br>' + schedule.description) if schedule.description else '' }}</div>">
                        <div class="schedule-time">
                            {{ schedule.start_time.strftime('%H:%M') }} - 
                            {{ schedule.end_time.strftime('%H:%M') }}
                        </div>
                        <div class="schedule-tech">{{ schedule.technician.username }}</div>
                        {% if schedule.location %}
                        <div class="schedule-location">
                            <i data-feather="map-pin" class="feather-small"></i> {{ schedule.location.name }}
                        </div>
                        {% endif %}
                        {% if schedule.description %}
                        <div class="schedule-description">{{ schedule.description }}</div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Schedule Modal -->
    <div class="modal fade" id="scheduleModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Schedule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="schedule_form" method="POST" action="{{ url_for('new_schedule') }}">
                        {{ form.hidden_tag() }}
                        <input type="hidden" id="schedule_id" name="schedule_id">
                        <input type="hidden" name="personal_view" value="true">
                        {% if request.args.get('week_start') %}
                        <input type="hidden" name="week_start" value="{{ request.args.get('week_start') }}">
                        {% endif %}
                        <div class="mb-3">
                            {{ form.description.label(class="form-label") }}
                            {{ form.description(class="form-control", id="description") }}
                        </div>
                        <div class="mb-3">
                            {{ form.location_id.label(class="form-label") }}
                            {{ form.location_id(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" id="schedule_date" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Repeat Schedule</label>
                            <div id="miniCalendar" class="mini-calendar">
                                <!-- Calendar will be generated here by JavaScript -->
                            </div>
                            <div id="selected-dates-container" class="mt-2 d-flex flex-wrap">
                                <!-- Selected dates will appear here -->
                            </div>
                            {{ form.repeat_days(id="repeat_days", class="d-none") }}
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label">Start Time</label>
                                <input type="time" id="start_time_input" class="form-control" value="09:00">
                                {{ form.start_time(id="start_time", class="d-none") }}
                            </div>
                            <div class="col">
                                <label class="form-label">End Time</label>
                                <input type="time" id="end_time_input" class="form-control" value="17:00">
                                {{ form.end_time(id="end_time", class="d-none") }}
                            </div>
                        </div>
                        <div class="mb-3 form-check">
                            {{ form.time_off(class="form-check-input", id="time_off") }}
                            {{ form.time_off.label(class="form-check-label") }}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" id="deleteScheduleBtn">Delete</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Schedule</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.calendar-container {
    background-color: var(--calendar-bg);
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

.day-column {
    width: calc((100% - 50px) / 7);
    border-right: 1px solid var(--border-color);
    position: relative;
}

.day-column:last-child {
    border-right: none;
}

.day-column.today {
    background-color: var(--today-highlight);
}

.day-header {
    padding: 10px;
    text-align: center;
    font-weight: bold;
    border-bottom: 1px solid var(--border-color);
    background: linear-gradient(to bottom, var(--calendar-header-start), var(--calendar-header-end));
    border-radius: 4px 4px 0 0;
}

.day-header.today {
    background: linear-gradient(to bottom, var(--calendar-today-header-start), var(--calendar-today-header-end));
    color: var(--calendar-today-text);
}

.week-view {
    display: flex;
    overflow-x: auto;
    min-height: 600px;
    max-height: calc(100vh - 200px);
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    margin-bottom: 20px;
    width: 100%;
}

.time-column {
    width: 50px;
    border-right: 1px solid var(--border-color);
    position: sticky;
    left: 0;
    background-color: var(--calendar-bg);
    z-index: 1;
}

.hour-slot {
    height: 60px;
    border-bottom: 1px solid var(--border-color);
    text-align: center;
    font-size: 0.8rem;
    padding-top: 5px;
}

.day-slots {
    position: relative;
}

.time-slot {
    height: 60px;
    border-bottom: 1px solid var(--border-color);
}

.schedule-event {
    position: absolute;
    width: calc(100% - 4px);
    left: 2px;
    border-radius: 4px;
    padding: 2px 5px;
    font-size: 0.8rem;
    overflow: hidden;
    color: #fff;
    cursor: pointer;
    z-index: 5;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    background: linear-gradient(135deg, var(--event-gradient-start), var(--event-gradient-end));
}

/* Make sure events are positioned correctly using JavaScript */
{% for day in range(7) %}
{% set current_date = week_start + timedelta(days=day) %}
{% for schedule in schedules if schedule.start_time.date() == current_date.date() %}
.day-column:nth-child({{ day + 2 }}) .schedule-event[data-schedule-id="{{ schedule.id }}"] {
    top: {{ ((schedule.start_time.hour * 60 + schedule.start_time.minute) / 60) * 60 }}px;
    height: {{ (((schedule.end_time - schedule.start_time).total_seconds() / 3600) * 60) }}px;
}
{% endfor %}
{% endfor %}

.schedule-time {
    font-weight: bold;
}

.schedule-tech {
    font-style: italic;
}

.schedule-location, .schedule-description {
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.feather-small {
    width: 12px;
    height: 12px;
}

.mini-calendar {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-top: 10px;
}

.mini-calendar-header {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.day-item {
    width: calc(100% / 7 - 6px);
    text-align: center;
    padding: 5px;
    border-radius: 4px;
    background-color: #f8f9fa;
    cursor: pointer;
}

.day-item.today {
    border: 1px solid #007bff;
    font-weight: bold;
}

.day-item.selected {
    background-color: #007bff;
    color: white;
}

.day-item.primary-date {
    background-color: #28a745;
    color: white;
}

.day-item.disabled {
    color: #adb5bd;
    cursor: not-allowed;
    background-color: #e9ecef;
}

.day-item.has-schedule {
    position: relative;
}

.day-item.has-schedule:after {
    content: '';
    position: absolute;
    bottom: 4px;
    left: 50%;
    transform: translateX(-50%);
    width: 4px;
    height: 4px;
    background-color: #dc3545;
    border-radius: 50%;
}

.selected-date-pill {
    background-color: #007bff;
    color: white;
    padding: 2px 10px;
    border-radius: 15px;
    margin: 2px;
    font-size: 0.9rem;
    cursor: pointer;
    display: flex;
    align-items: center;
}

#selected-dates-container {
    min-height: 38px;
}
</style>

<script>
// Initialize tooltips and calendar javascript after the document is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips for schedule events
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function(tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl, {
            html: true,
            container: 'body',
            boundary: 'window'
        });
    });
    
    // Only initialize calendar components when the modal is opened
    const scheduleModal = document.getElementById('scheduleModal');
    if (scheduleModal) {
        scheduleModal.addEventListener('show.bs.modal', function() {
            // Calendar initialization
            let currentMonth = new Date();
            let selectedDates = [];
            let primaryDate = null;
            
            // Get all schedule dates for highlighting
            const scheduleDates = [];
            document.querySelectorAll('.schedule-event').forEach(event => {
                const startTime = new Date(event.getAttribute('data-start-time'));
                const dateStr = startTime.toISOString().split('T')[0];
                if (!scheduleDates.includes(dateStr)) {
                    scheduleDates.push(dateStr);
                }
            });
            
            // Initialize the mini calendar
            if (typeof initMiniCalendar === 'function') {
                initMiniCalendar();
            }
        });
    }
    
    // Initialize form handlers for the modal
    document.getElementById('scheduleModal').addEventListener('show.bs.modal', function(event) {
        // Clear previous selections
        selectedDates = [];
        primaryDate = null;
        clearDateSelection();
        
        // If triggered by a schedule event (for editing)
        if (event.relatedTarget && event.relatedTarget.classList.contains('schedule-event')) {
            const scheduleEvent = event.relatedTarget;
            document.getElementById('schedule_id').value = scheduleEvent.getAttribute('data-schedule-id');
            
            // Populate the form with existing data
            const startTime = new Date(scheduleEvent.getAttribute('data-start-time'));
            const endTime = new Date(scheduleEvent.getAttribute('data-end-time'));
            const timeOff = scheduleEvent.getAttribute('data-time-off') === 'true';
            
            // Set the date
            document.getElementById('schedule_date').valueAsDate = startTime;
            
            // Set the times
            document.getElementById('start_time_input').value = 
                `${String(startTime.getHours()).padStart(2, '0')}:${String(startTime.getMinutes()).padStart(2, '0')}`;
            document.getElementById('end_time_input').value = 
                `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`;
            
            // Set the time off checkbox
            document.getElementById('time_off').checked = timeOff;
            
            // Get description from the schedule element
            const descElement = scheduleEvent.querySelector('.schedule-description');
            document.getElementById('description').value = descElement ? descElement.textContent : '';
            
            // Set modal title
            document.querySelector('#scheduleModal .modal-title').textContent = 'Edit Schedule';
            
            // Show delete button
            document.getElementById('deleteScheduleBtn').style.display = 'block';
            document.getElementById('deleteScheduleBtn').onclick = function() {
                if (confirm('Are you sure you want to delete this schedule?')) {
                    window.location.href = `/schedule/delete/${scheduleEvent.getAttribute('data-schedule-id')}?week_start={{ week_start.strftime('%Y-%m-%d') }}&personal_view=true`;
                }
            };
        } else {
            // Creating new schedule
            document.getElementById('schedule_id').value = '';
            document.getElementById('description').value = '';
            document.getElementById('time_off').checked = false;
            document.querySelector('#scheduleModal .modal-title').textContent = 'Add New Schedule';
            document.getElementById('deleteScheduleBtn').style.display = 'none';
            
            // Set default date to the clicked day or today
            const clickedDate = event.relatedTarget ? event.relatedTarget.getAttribute('data-date') : null;
            if (clickedDate) {
                document.getElementById('schedule_date').value = clickedDate;
                primaryDate = clickedDate;
                selectedDates = [clickedDate];
                updateSelectedDatesDisplay();
            } else {
                const now = new Date();
                document.getElementById('schedule_date').valueAsDate = now;
            }
            
            // Set default times (9am - 5pm)
            document.getElementById('start_time_input').value = '09:00';
            document.getElementById('end_time_input').value = '17:00';
        }
        
        // Update the calendar display
        updateMiniCalendar();
    });
    
    // Handle form submission
    document.getElementById('schedule_form').addEventListener('submit', function(event) {
        // Combine the date and time inputs
        const dateInput = document.getElementById('schedule_date').value;
        const startTimeInput = document.getElementById('start_time_input').value;
        const endTimeInput = document.getElementById('end_time_input').value;
        
        if (dateInput && startTimeInput && endTimeInput) {
            const startDateTime = new Date(`${dateInput}T${startTimeInput}`);
            const endDateTime = new Date(`${dateInput}T${endTimeInput}`);
            
            document.getElementById('start_time').value = 
                `${startDateTime.getFullYear()}-${String(startDateTime.getMonth() + 1).padStart(2, '0')}-${String(startDateTime.getDate()).padStart(2, '0')} ${String(startDateTime.getHours()).padStart(2, '0')}:${String(startDateTime.getMinutes()).padStart(2, '0')}`;
            
            document.getElementById('end_time').value = 
                `${endDateTime.getFullYear()}-${String(endDateTime.getMonth() + 1).padStart(2, '0')}-${String(endDateTime.getDate()).padStart(2, '0')} ${String(endDateTime.getHours()).padStart(2, '0')}:${String(endDateTime.getMinutes()).padStart(2, '0')}`;
        }
        
        // Set the repeat days field
        if (selectedDates.length > 0) {
            document.getElementById('repeat_days').value = selectedDates.join(',');
        }
    });

    // Functions for the mini calendar
    function initMiniCalendar() {
        const miniCalendar = document.getElementById('miniCalendar');
        if (!miniCalendar) return;
        
        // Create header
        const header = document.createElement('div');
        header.className = 'mini-calendar-header';
        
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '&laquo;';
        prevBtn.className = 'btn btn-sm btn-outline-secondary';
        prevBtn.onclick = () => navigateMonth(-1);
        
        const monthLabel = document.createElement('span');
        monthLabel.id = 'calendar-month-label';
        monthLabel.textContent = currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '&raquo;';
        nextBtn.className = 'btn btn-sm btn-outline-secondary';
        nextBtn.onclick = () => navigateMonth(1);
        
        header.appendChild(prevBtn);
        header.appendChild(monthLabel);
        header.appendChild(nextBtn);
        miniCalendar.appendChild(header);
        
        // Create day headers
        const dayNames = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
        dayNames.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'day-item';
            dayHeader.style.fontWeight = 'bold';
            dayHeader.textContent = day;
            dayHeader.style.cursor = 'default';
            miniCalendar.appendChild(dayHeader);
        });
        
        // Generate calendar days
        generateCalendarDays();
    }
    
    function generateCalendarDays() {
        const miniCalendar = document.getElementById('miniCalendar');
        if (!miniCalendar) return;
        
        // Remove existing calendar days
        const existingDays = miniCalendar.querySelectorAll('.day-item:not(:nth-child(-n+8))');
        existingDays.forEach(day => day.remove());
        
        // Update the month label
        const monthLabel = document.getElementById('calendar-month-label');
        monthLabel.textContent = currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        
        // Get the first day of the month
        const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
        const startingDay = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
        
        // Get the number of days in the month
        const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
        const totalDays = lastDay.getDate();
        
        // Add empty cells for the days before the first day of the month
        for (let i = 0; i < startingDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'day-item disabled';
            miniCalendar.appendChild(emptyDay);
        }
        
        // Add the days of the month
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        for (let day = 1; day <= totalDays; day++) {
            const date = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day);
            const dateFormatted = formatDate(date);
            const isToday = date.getTime() === today.getTime();
            const isPrimary = primaryDate === dateFormatted;
            const isSelected = selectedDates.includes(dateFormatted);
            
            // Check if this date has a schedule
            const hasSchedule = scheduleDates.includes(dateFormatted);
            
            // Create day element
            const dayItem = document.createElement('div');
            dayItem.className = 'day-item';
            dayItem.textContent = day;
            dayItem.setAttribute('data-date', dateFormatted);
            
            // Add classes based on state
            if (isToday) dayItem.classList.add('today');
            if (isPrimary) dayItem.classList.add('primary-date');
            else if (isSelected) dayItem.classList.add('selected');
            if (hasSchedule) dayItem.classList.add('has-schedule');
            
            // Add click handler
            dayItem.addEventListener('click', () => toggleDateSelection(dateFormatted, dayItem));
            
            miniCalendar.appendChild(dayItem);
        }
    }
    
    function toggleDateSelection(dateStr, dayItem) {
        const index = selectedDates.indexOf(dateStr);
        
        if (index > -1) {
            // Deselect date
            selectedDates.splice(index, 1);
            dayItem.classList.remove('selected');
            
            // If this was the primary date, clear primary
            if (primaryDate === dateStr) {
                primaryDate = null;
                dayItem.classList.remove('primary-date');
            }
        } else {
            // Select date
            selectedDates.push(dateStr);
            
            // If this is the first date, make it primary
            if (!primaryDate) {
                primaryDate = dateStr;
                dayItem.classList.add('primary-date');
            } else {
                dayItem.classList.add('selected');
            }
        }
        
        // Update the date input
        if (primaryDate) {
            document.getElementById('schedule_date').value = primaryDate;
        }
        
        // Update the selected dates display
        updateSelectedDatesDisplay();
    }
    
    function updateSelectedDatesDisplay() {
        const container = document.getElementById('selected-dates-container');
        if (!container) return;
        
        // Clear the container
        container.innerHTML = '';
        
        // Add date pills
        selectedDates.forEach(dateStr => {
            const pill = document.createElement('div');
            pill.className = 'selected-date-pill';
            
            // Format the date
            const date = parseDate(dateStr);
            const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            
            // Create the pill content
            pill.innerHTML = `${formattedDate} ${dateStr === primaryDate ? '<span class="ms-1 badge bg-success">Primary</span>' : '<span class="ms-1">×</span>'}`;
            
            // Add click handler to remove
            pill.addEventListener('click', () => {
                const index = selectedDates.indexOf(dateStr);
                if (index > -1) {
                    selectedDates.splice(index, 1);
                    if (dateStr === primaryDate) {
                        primaryDate = selectedDates.length > 0 ? selectedDates[0] : null;
                    }
                    updateMiniCalendar();
                    updateSelectedDatesDisplay();
                }
            });
            
            container.appendChild(pill);
        });
    }
    
    function updateMiniCalendar() {
        // Update the calendar display
        generateCalendarDays();
        
        // Update the header month if primary date changes
        if (primaryDate) {
            const primaryDateObj = parseDate(primaryDate);
            if (primaryDateObj.getMonth() !== currentMonth.getMonth() || 
                primaryDateObj.getFullYear() !== currentMonth.getFullYear()) {
                currentMonth = new Date(primaryDateObj.getFullYear(), primaryDateObj.getMonth(), 1);
                generateCalendarDays();
            }
        }
    }
    
    function navigateMonth(direction) {
        currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + direction, 1);
        generateCalendarDays();
    }
    
    function clearDateSelection(keepHidden = false) {
        selectedDates = [];
        primaryDate = null;
        
        // Clear the input
        if (!keepHidden) {
            document.getElementById('repeat_days').value = '';
        }
        
        // Update UI
        updateMiniCalendar();
        updateSelectedDatesDisplay();
    }
    
    function formatDate(date) {
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    }
    
    function parseDate(dateStr) {
        const [year, month, day] = dateStr.split('-').map(Number);
        return new Date(year, month - 1, day);
    }
});
</script>
{% endblock %}