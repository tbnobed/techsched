{% extends "base.html" %}

{% block content %}
<div class="tickets-dashboard">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>Tickets</h2>
            <p class="text-muted">Showing {{ ticket_count }} ticket{% if ticket_count != 1 %}s{% endif %}</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('tickets.create_ticket') }}" class="btn btn-primary">
                <i data-feather="plus"></i> New Ticket
            </a>
            {% if current_user.is_admin %}
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="adminActionsDropdown" 
                        data-bs-toggle="dropdown" aria-expanded="false">
                    <i data-feather="settings"></i> Admin Actions
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="adminActionsDropdown">
                    <li>
                        <a class="dropdown-item" href="{{ url_for('tickets.manage_categories') }}">
                            <i data-feather="tag"></i> Manage Categories
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="{{ url_for('tickets.archived_tickets') }}">
                            <i data-feather="archive"></i> View Archived Tickets
                        </a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#batchArchiveModal">
                            <i data-feather="package"></i> Batch Archive Tickets
                        </a>
                    </li>
                </ul>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5>Filter Tickets</h5>
                    <form id="filter-form" method="GET" autocomplete="off" novalidate>
                        <div class="mb-3">
                            <label class="form-label">Search</label>
                            <div class="input-group">
                                <input type="text" name="search" class="form-control" placeholder="Keywords in title/description" value="{{ filter_info.search }}">
                                <button type="submit" class="btn btn-sm btn-secondary">
                                    <i data-feather="search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select name="status" id="status-filter" class="form-select">
                                <option value="all" {% if filter_info and filter_info.status == 'all' %}selected{% endif %}>All</option>
                                {% for status in ticket_statuses %}
                                <option value="{{ status }}" {% if filter_info and filter_info.status == status %}selected{% endif %}>
                                    {{ status|replace('_', ' ')|title }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <select name="category" id="category-filter" class="form-select">
                                <option value="all" {% if filter_info and filter_info.category == 'all' %}selected{% endif %}>All</option>
                                {% for category in categories %}
                                <option value="{{ category['id'] }}" {% if filter_info and filter_info.category|string == category['id']|string %}selected{% endif %}>
                                    {{ category['name'] }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Priority</label>
                            <select name="priority" id="priority-filter" class="form-select">
                                <option value="all" {% if filter_info and filter_info.priority == 'all' %}selected{% endif %}>All</option>
                                <option value="0" {% if filter_info and (filter_info.priority == '0' or filter_info.priority == 0) %}selected{% endif %}>Low</option>
                                <option value="1" {% if filter_info and (filter_info.priority == '1' or filter_info.priority == 1) %}selected{% endif %}>Medium</option>
                                <option value="2" {% if filter_info and (filter_info.priority == '2' or filter_info.priority == 2) %}selected{% endif %}>High</option>
                                <option value="3" {% if filter_info and (filter_info.priority == '3' or filter_info.priority == 3) %}selected{% endif %}>Urgent</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Technician</label>
                            <select name="technician" id="technician-filter" class="form-select">
                                <option value="all" {% if filter_info and filter_info.technician == 'all' %}selected{% endif %}>All</option>
                                {% for technician in technicians %}
                                <option value="{{ technician.id }}" {% if filter_info and filter_info.technician|string == technician.id|string %}selected{% endif %}>
                                    {{ technician.username }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="button" id="apply-filters-btn" class="btn btn-primary w-100">Apply Filters</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>Assigned To</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ticket in tickets %}
                                <tr>
                                    <td>#{{ ticket['id'] }}</td>
                                    <td>
                                        <a href="{{ url_for('tickets.view_ticket', ticket_id=ticket['id']) }}" class="text-decoration-none">
                                            {{ ticket['title'] }}
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">
                                            {{ ticket['category']['name'] }}
                                        </span>
                                    </td>
                                    <td>
                                        {% set status_colors = {
                                            'open': 'primary',
                                            'in_progress': 'info',
                                            'pending': 'warning',
                                            'resolved': 'success',
                                            'closed': 'secondary'
                                        } %}
                                        <span class="badge bg-{{ status_colors[ticket['status']] }}">
                                            {{ ticket['status']|replace('_', ' ')|title }}
                                        </span>
                                    </td>
                                    <td>
                                        {% set priority_colors = {
                                            0: 'secondary',
                                            1: 'info',
                                            2: 'warning',
                                            3: 'danger'
                                        } %}
                                        {% set priority_labels = {
                                            0: 'Low',
                                            1: 'Medium',
                                            2: 'High',
                                            3: 'Urgent'
                                        } %}
                                        <span class="badge bg-{{ priority_colors[ticket['priority']] }}">
                                            {{ priority_labels[ticket['priority']] }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if ticket['assigned_technician'] %}
                                            {{ ticket['assigned_technician']['username'] }}
                                        {% else %}
                                            <span class="text-muted">Unassigned</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ ticket['created_at'].strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>
                                        <a href="{{ url_for('tickets.view_ticket', ticket_id=ticket['id']) }}" class="btn btn-sm btn-primary">
                                            View
                                        </a>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <i data-feather="inbox" class="mb-2" style="width: 48px; height: 48px;"></i>
                                        <p class="mb-0">No tickets found matching your criteria.</p>
                                        {% if filter_info %}
                                        <small class="d-block mt-2 text-muted">
                                            Filters: Status={{ filter_info['status'] }}, Priority={{ filter_info['priority'] }}, Category={{ filter_info['category'] }}, Technician={{ filter_info['technician'] }}
                                        </small>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Initialize Feather icons and handle custom filter submission
    document.addEventListener('DOMContentLoaded', function() {
        feather.replace({ 'class': 'feather-sm' });
        
        // Handle the apply filters button click
        const applyFilterBtn = document.getElementById('apply-filters-btn');
        if (applyFilterBtn) {
            applyFilterBtn.addEventListener('click', function() {
                // Use form data to collect all filter values consistently
                const form = document.getElementById('filter-form');
                const formData = new FormData(form);
                
                // Build query string
                const params = new URLSearchParams();
                
                // Add all form values
                for (const [key, value] of formData.entries()) {
                    if (value) {
                        params.append(key, value);
                    }
                }
                
                // Add cache-busting parameter
                params.append('timestamp', Date.now());
                params.append('rand', Math.random());
                
                // Keep the current path and just update query params
                const currentPath = window.location.pathname;
                const newUrl = `${currentPath}?${params.toString()}`;
                
                console.log('Navigating to URL:', newUrl);
                
                // Force reload the page with the new URL
                window.location.href = newUrl;
            });
        }
        
        // For debugging - add info about current filters
        console.log('Current filters:', {
            status: '{{ filter_info.status }}',
            category: '{{ filter_info.category }}',
            priority: '{{ filter_info.priority }}',
            technician: '{{ filter_info.technician }}',
            search: '{{ filter_info.search }}',
            timestamp: '{{ timestamp }}'
        });
    });
</script>

<!-- Batch Archive Modal -->
{% if current_user.is_admin %}
<div class="modal fade" id="batchArchiveModal" tabindex="-1" aria-labelledby="batchArchiveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="batchArchiveModalLabel">Batch Archive Tickets</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('tickets.batch_archive_tickets') }}" method="post">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i data-feather="alert-triangle"></i>
                        <strong>Warning:</strong> Archived tickets will be hidden from regular views.
                        You can still view them in the Archive section, but they will not appear in regular searches or reports.
                    </div>
                    
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="all">All Statuses</option>
                            <option value="closed" selected>Closed Only</option>
                            <option value="resolved">Resolved Only</option>
                            <option value="pending">Pending Only</option>
                            <option value="in_progress">In Progress Only</option>
                            <option value="open">Open Only</option>
                        </select>
                        <div class="form-text">Select which ticket status to archive</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="date_before" class="form-label">Last Updated Before</label>
                        <input type="date" class="form-control" id="date_before" name="date_before">
                        <div class="form-text">Archive tickets that were not updated since this date</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i data-feather="archive"></i> Archive Tickets
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}