{% extends "base.html" %}

{% block content %}
<div class="tickets-dashboard">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Tickets</h2>
        <div class="d-flex gap-2">
            <a href="{{ url_for('tickets.create_ticket') }}" class="btn btn-primary">
                <i data-feather="plus"></i> New Ticket
            </a>
            {% if current_user.is_admin %}
            <a href="{{ url_for('tickets.manage_categories') }}" class="btn btn-outline-secondary">
                <i data-feather="tag"></i> Manage Categories
            </a>
            {% endif %}
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5>Filter Tickets</h5>
                    <form method="GET" action="{{ url_for('tickets.tickets_dashboard') }}">
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-select">
                                <option value="all">All</option>
                                {% for status in ticket_statuses %}
                                <option value="{{ status }}" {% if request.args.get('status') == status %}selected{% endif %}>
                                    {{ status|replace('_', ' ')|title }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <select name="category" class="form-select">
                                <option value="all">All</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" {% if request.args.get('category')|int == category.id %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Priority</label>
                            <select name="priority" class="form-select">
                                <option value="all">All</option>
                                <option value="0" {% if request.args.get('priority') == '0' %}selected{% endif %}>Low</option>
                                <option value="1" {% if request.args.get('priority') == '1' %}selected{% endif %}>Medium</option>
                                <option value="2" {% if request.args.get('priority') == '2' %}selected{% endif %}>High</option>
                                <option value="3" {% if request.args.get('priority') == '3' %}selected{% endif %}>Urgent</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>Assigned To</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ticket in tickets %}
                                <tr>
                                    <td>#{{ ticket.id }}</td>
                                    <td>
                                        <a href="{{ url_for('tickets.view_ticket', ticket_id=ticket.id) }}" class="text-decoration-none">
                                            {{ ticket.title }}
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">
                                            <i data-feather="{{ ticket.category.icon }}" class="feather-sm me-1"></i>
                                            {{ ticket.category.name }}
                                        </span>
                                    </td>
                                    <td>
                                        {% set status_colors = {
                                            'open': 'primary',
                                            'in_progress': 'info',
                                            'pending': 'warning',
                                            'resolved': 'success',
                                            'closed': 'secondary'
                                        } %}
                                        <span class="badge bg-{{ status_colors[ticket.status] }}">
                                            {{ ticket.status|replace('_', ' ')|title }}
                                        </span>
                                    </td>
                                    <td>
                                        {% set priority_colors = {
                                            0: 'secondary',
                                            1: 'info',
                                            2: 'warning',
                                            3: 'danger'
                                        } %}
                                        {% set priority_labels = {
                                            0: 'Low',
                                            1: 'Medium',
                                            2: 'High',
                                            3: 'Urgent'
                                        } %}
                                        <span class="badge bg-{{ priority_colors[ticket.priority] }}">
                                            {{ priority_labels[ticket.priority] }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if ticket.assigned_technician %}
                                            {{ ticket.assigned_technician.username }}
                                        {% else %}
                                            <span class="text-muted">Unassigned</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ ticket.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>
                                        <a href="{{ url_for('tickets.view_ticket', ticket_id=ticket.id) }}" class="btn btn-sm btn-primary">
                                            View
                                        </a>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <i data-feather="inbox" class="mb-2" style="width: 48px; height: 48px;"></i>
                                        <p class="mb-0">No tickets found matching your criteria.</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Initialize Feather icons
    document.addEventListener('DOMContentLoaded', function() {
        feather.replace({ 'class': 'feather-sm' });
    });
</script>
{% endblock %}